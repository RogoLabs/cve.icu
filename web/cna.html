<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>CNA Analysis - CVE.ICU</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W0CE61HN2F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-W0CE61HN2F');
    </script>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="static/images/logo.png">
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="static/css/style.css">
    
    <!-- Meta tags for SEO -->
    <meta name="description" content="CVE.ICU provides comprehensive analysis and visualization of Common Vulnerabilities and Exposures (CVE) data from 1999 to present.">
    <meta name="keywords" content="CVE, vulnerabilities, security, analysis, dashboard, cybersecurity">
    <meta name="author" content="CVE.ICU">
    
    <!-- Mobile-specific meta tags -->
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CVE.ICU">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Open Graph tags -->
    <meta property="og:title" content="CVE.ICU - CVE Analysis Dashboard">
    <meta property="og:description" content="Comprehensive CVE analysis and visualization from 1999 to present">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cve.icu">
    <meta property="og:image" content="https://cve.icu/static/images/logo.png">
</head>
<body>
    <!-- Header and Navigation -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="static/images/logo.png" alt="CVE.ICU Logo">
                CVE.ICU
            </a>
            
            <nav class="nav">
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="years.html">Yearly Analysis</a></li>
                    <li class="nav-dropdown">
                        <a href="cna-hub.html" class="dropdown-toggle">CNA</a>
                        <ul class="dropdown-menu">
                            <li><a href="cna.html">CNA Intelligence</a></li>
                            <li><a href="data-quality.html">Name Matching</a></li>
                        </ul>
                    </li>
                    <li><a href="cpe.html">CPE</a></li>
                    <li><a href="cwe.html">CWE</a></li>
                    <li class="nav-dropdown">
                        <a href="scoring.html" class="dropdown-toggle">Scoring</a>
                        <ul class="dropdown-menu">
                            <li><a href="cvss.html">CVSS</a></li>
                            <li><a href="epss.html">EPSS</a></li>
                            <li><a href="kev.html">KEV</a></li>
                        </ul>
                    </li>
                    <li><a href="growth.html">Growth</a></li>
                    <li><a href="calendar.html">Calendar</a></li>
                </ul>
                <button class="nav-toggle" aria-label="Toggle navigation">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        
<!-- Hero Section -->
<div class="page-header mb-4 text-center">
    <h1 class="display-4 mb-2">CNA Intelligence Dashboard</h1>
    <small class="text-muted d-block mb-3" id="pageSubtitle">
        Showing comprehensive analysis across all years (1999-2026)
    </small>
    
    <!-- Data Mode Toggle -->
    <div class="d-flex justify-content-center mb-3">
        <button type="button" id="dataToggleBtn" onclick="toggleDataMode()" style="
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            transition: all 0.15s ease-in-out;
            background: none;
            border: 2px solid var(--color-border);
            cursor: pointer;
            font-size: inherit;
        " onmouseover="this.style.color='var(--color-accent)'; this.style.backgroundColor='rgba(13, 110, 253, 0.1)'; this.style.borderColor='var(--color-accent)'" onmouseout="this.style.color='var(--color-text-secondary)'; this.style.backgroundColor='transparent'; this.style.borderColor='var(--color-border)'">
            <span id="toggleText">Switch to 2026 Only</span>
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-number" id="activeCnas">Loading...</div>
        <div class="stat-label">Active CNAs</div>
        <small class="text-muted" style="font-size: 0.75rem;">üìà Currently publishing</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="highVolumeCnas">Loading...</div>
        <div class="stat-label">High-Volume CNAs</div>
        <small class="text-muted" style="font-size: 0.75rem;">üöÄ CNAs with 1000+ CVEs</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="medianYearsActive">Loading...</div>
        <div class="stat-label">Median Years Active</div>
        <small class="text-muted" style="font-size: 0.75rem;">üìä Typical CNA lifespan</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="marketConcentration">Loading...</div>
        <div class="stat-label">Top 5 CNA Share</div>
        <small class="text-muted" style="font-size: 0.75rem;">üìä Concentration of assignments</small>
    </div>
</div>

<!-- Top CNAs and CNA Type Distribution -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">Top CNAs by Volume</h3>
                <small class="text-muted">Leading CVE Numbering Authorities by total assignments</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="topCnasChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">CNA Type Distribution</h3>
                <small class="text-muted">CNAs by organization type</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="cnaTypeChart"></canvas>
                </div>
                <small class="text-muted mt-2 d-block">
                    <i class="fas fa-info-circle me-1"></i>
                    Note: CNAs can and often have multiple types (e.g., Vendor + Researcher).
                </small>
            </div>
        </div>
    </div>
</div>

<!-- CNA Activity Analysis -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">CNA Lifecycle Stages</h3>
                <small class="text-muted">CNAs categorized by years of activity</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="cnaActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">üéØ Top CNAs by KEV Count</h3>
                <small class="text-muted">CNAs with most known exploited vulnerabilities</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="cnaKevChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analysis Charts -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">CNA Assignment Volume</h3>
                <small class="text-muted">CNAs categorized by total CVE assignments</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="cnaVolumeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">üìà CNA Growth Leaders</h3>
                <small class="text-muted">Most active CNAs in the current year</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="cnaGrowthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Smart Insights Panel -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üîç CNA Intelligence Insights</h3>
    </div>
    <div class="card-body py-3">
        <div class="row" id="cnaInsights">
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üèÜ</div>
                    <div class="insight-content">
                        <div class="insight-title">Top CNA</div>
                        <div class="insight-text" id="marketLeaderInsight">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-content">
                        <div class="insight-title">Activity Status</div>
                        <div class="insight-text" id="activityInsight">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üè¢</div>
                    <div class="insight-content">
                        <div class="insight-title">Years Active</div>
                        <div class="insight-text" id="orgTypeInsight">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed CNA Table -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üìã Comprehensive CNA Directory</h3>
        <small class="text-muted">All CVE Numbering Authorities with assignment statistics - Click column headers to sort</small>
    </div>
    <div class="card-body py-3">
        <!-- Filter Controls -->
        <div class="filter-bar mb-3" id="filterBar">
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <div class="filter-group">
                    <label class="filter-label">Type:</label>
                    <select id="filterType" class="filter-select" onchange="applyFilters()">
                        <option value="">All Types</option>
                        <option value="Vendor">Vendor</option>
                        <option value="CERT">CERT</option>
                        <option value="Security Researcher">Security Researcher</option>
                        <option value="Open Source">Open Source</option>
                        <option value="Government">Government</option>
                        <option value="Program">Program</option>
                        <option value="Academic">Academic</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status:</label>
                    <select id="filterStatus" class="filter-select" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">
                        <input type="checkbox" id="filterKev" onchange="applyFilters()">
                        Has KEV CVEs
                    </label>
                </div>
                <div class="filter-group">
                    <label class="filter-label">
                        <input type="checkbox" id="filterHighVolume" onchange="applyFilters()">
                        High Volume (1000+)
                    </label>
                </div>
                <div class="filter-group ms-auto">
                    <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">Reset Filters</button>
                </div>
            </div>
            <div class="filter-summary mt-2" id="filterSummary" style="display: none;">
                <small class="text-muted"><span id="filteredCount">0</span> CNAs match current filters</small>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="cnaTable">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="rank" style="width: 80px;">Rank <span class="sort-indicator">‚ñº</span></th>
                        <th class="sortable" data-sort="name" style="width: 280px;">CNA Name <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="count" style="width: 130px;">CVEs Assigned <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="years_active" style="width: 120px;">Years Active <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="last_cve_date" style="width: 140px;">Last CVE Date <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="activity_status" style="width: 100px;">Status <span class="sort-indicator"></span></th>
                        <th style="width: 80px;">Scorecard</th>
                    </tr>
                </thead>
                <tbody id="cnaTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">Loading CNA data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="mt-3 text-center">
            <div class="text-muted mb-2" id="paginationInfo">
                Showing 1-25 of 0 CNAs
            </div>
            <nav aria-label="CNA table pagination" class="d-inline-block">
                <ul class="pagination pagination-sm mb-0" id="paginationControls">
                    <!-- Pagination will be dynamically generated -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Export and Share Panel -->
<div class="card mb-3">
    <div class="card-header py-2">
        <h2 class="card-title mb-0" style="font-size: 1.1rem;">üì§ Export & Share</h2>
    </div>
    <div class="card-body py-3">
        <div class="export-buttons">
            <button class="btn btn-primary btn-sm" onclick="exportCnaCSV()">üìä Export CSV</button>
            <button class="btn btn-primary btn-sm" onclick="exportCnaJSON()">üìã Export JSON</button>
            <button class="btn btn-secondary btn-sm" onclick="generatePermalink()">üîó Share Link</button>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è Print Report</button>
        </div>
        <div class="permalink-result mt-2" id="permalinkResult" style="display: none;">
            <input type="text" class="form-control" id="permalinkInput" readonly>
            <button class="btn btn-outline-primary btn-sm mt-1" onclick="copyPermalink()">Copy Link</button>
        </div>
    </div>
</div>

<!-- Data Source Note -->



    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: space-between;">
                <div style="flex: 1; min-width: 200px;">
                    <p class="mb-1"><strong>Data Sources:</strong></p>
                    <p class="text-muted small mb-0">
                        <a href="https://nvd.nist.gov/" target="_blank" class="text-decoration-none">National Vulnerability Database (NVD)</a><br>
                        <a href="https://cve.org/" target="_blank" class="text-decoration-none">CVE Program</a><br>
                        Last updated: <span id="lastUpdated">Loading...</span>
                    </p>
                </div>
                <div style="flex: 1; min-width: 200px; text-align: right;">
                    <p class="mb-1"><strong>Platform Links:</strong></p>
                    <p class="text-muted small mb-0">
                        <a href="about.html" class="text-decoration-none">About CVE.ICU</a><br>
                        <a href="https://cnascorecard.org" target="_blank" class="text-decoration-none">CNA Scorecard</a><br>
                        <a href="https://cveforecast.org" target="_blank" class="text-decoration-none">CVE Forecast</a><br>
                        <a href="https://github.com/rogolabs/cve.icu" target="_blank" class="text-decoration-none">GitHub Repository</a>
                    </p>
                </div>
            </div>
            <hr class="my-2">
            <div class="text-center">
                <small class="text-muted">
                    &copy; 2026 CVE.ICU ‚Ä¢ Built by <a href="https://rogolabs.net" target="_blank" class="text-decoration-none">RogoLabs</a><br>
                    Data updated every 6 hours ‚Ä¢ CVE coverage: 1999-2026
                </small>
            </div>
        </div>
    </footer>

    <!-- Chart.js Library (UMD version) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Universal timestamp loader -->
    <script>
    // Shared request cache to deduplicate JSON fetches within a page load.
    window.CVE_REQUEST_CACHE = window.CVE_REQUEST_CACHE || new Map();
    window.fetchJsonCached = window.fetchJsonCached || function(url, options = {}) {
        const {
            force = false,
            retries = 2,
            timeoutMs = 10000,
            retryDelayMs = 300
        } = options;
        const resolvedUrl = new URL(url, window.location.href).toString();

        if (!force && window.CVE_REQUEST_CACHE.has(resolvedUrl)) {
            return window.CVE_REQUEST_CACHE.get(resolvedUrl);
        }

        const retryableStatuses = new Set([408, 409, 425, 429, 500, 502, 503, 504]);
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const isRetryableNetworkError = (error) => {
            if (!error) return false;
            if (error.name === 'AbortError') return true;
            const message = String(error.message || '').toLowerCase();
            return message.includes('networkerror') || message.includes('failed to fetch');
        };
        const doFetch = async (attempt = 0) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                const response = await fetch(resolvedUrl, { signal: controller.signal });
                if (!response.ok) {
                    const error = new Error(`HTTP error ${response.status} for ${resolvedUrl}`);
                    error.status = response.status;
                    throw error;
                }
                return await response.json();
            } catch (error) {
                const status = typeof error.status === 'number' ? error.status : null;
                const canRetry = attempt < retries && (
                    isRetryableNetworkError(error) ||
                    (status !== null && retryableStatuses.has(status))
                );

                if (!canRetry) {
                    throw error;
                }

                const backoffMs = retryDelayMs * Math.pow(2, attempt);
                await wait(backoffMs);
                return doFetch(attempt + 1);
            } finally {
                clearTimeout(timeoutId);
            }
        };

        const request = doFetch();

        // Remove failed entries so retries can recover.
        const cachedRequest = request.catch(error => {
            window.CVE_REQUEST_CACHE.delete(resolvedUrl);
            throw error;
        });

        if (!force) {
            window.CVE_REQUEST_CACHE.set(resolvedUrl, cachedRequest);
        }
        return cachedRequest;
    };

    // Universal function to load and display the last updated timestamp
    // Uses cve_all.json as the single source of truth for all pages
    function loadUniversalTimestamp() {
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (!lastUpdatedElement) return;
        
        window.fetchJsonCached('data/cve_all.json')
            .then(data => {
                if (data.generated_at) {
                    const date = new Date(data.generated_at);
                    const options = {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false, // Use 24-hour clock
                        timeZone: 'UTC', // Always show UTC
                        timeZoneName: 'short'
                    };
                    const formattedDate = date.toLocaleString('en-US', options);
                    lastUpdatedElement.textContent = formattedDate;
                } else {
                    lastUpdatedElement.textContent = 'Unknown';
                }
            })
            .catch(error => {
                console.error('Error loading timestamp:', error);
                lastUpdatedElement.textContent = 'Error loading timestamp';
            });
    }
    
    // Load timestamp when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        loadUniversalTimestamp();
    });
    </script>
    
    <!-- Mobile Navigation Enhancement -->
    <script>
        // Enhanced mobile navigation toggle
        document.addEventListener('DOMContentLoaded', function() {
            const navToggle = document.querySelector('.nav-toggle');
            const navMenu = document.querySelector('.nav-menu');
            
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                    
                    // Prevent body scroll when menu is open
                    if (navMenu.classList.contains('active')) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    const isClickInside = navToggle.contains(event.target) || navMenu.contains(event.target);
                    
                    if (!isClickInside && navMenu.classList.contains('active')) {
                        navMenu.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
                
                // Close menu when a nav link is clicked
                const navLinks = navMenu.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        navMenu.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
            }
        });
    </script>
    
    <!-- Custom JavaScript -->
    <script>
        // Wait for Chart.js to load before configuring
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart !== 'undefined') {
                // Global configuration for Chart.js with design system
                Chart.defaults.responsive = true;
                Chart.defaults.maintainAspectRatio = false;
                Chart.defaults.plugins.legend.position = 'top';
                Chart.defaults.plugins.legend.labels.usePointStyle = true;
                Chart.defaults.plugins.legend.labels.padding = 20;
                Chart.defaults.plugins.legend.labels.font = {
                    family: 'Inter, sans-serif',
                    size: 12,
                    weight: '500'
                };
                Chart.defaults.plugins.title.display = true;
                Chart.defaults.plugins.title.font = {
                    family: 'Inter, sans-serif',
                    size: 16,
                    weight: '600'
                };
                Chart.defaults.plugins.title.color = '#212529';
                Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(255, 255, 255, 0.95)';
                Chart.defaults.plugins.tooltip.titleColor = '#212529';
                Chart.defaults.plugins.tooltip.bodyColor = '#6c757d';
                Chart.defaults.plugins.tooltip.borderColor = '#dee2e6';
                Chart.defaults.plugins.tooltip.borderWidth = 1;
                Chart.defaults.plugins.tooltip.cornerRadius = 8;
                Chart.defaults.plugins.tooltip.titleFont = {
                    family: 'Inter, sans-serif',
                    size: 13,
                    weight: '600'
                };
                Chart.defaults.plugins.tooltip.bodyFont = {
                    family: 'Inter, sans-serif',
                    size: 12,
                    weight: '400'
                };
                // Chart.js v4 scale configuration
                Chart.defaults.elements.point.backgroundColor = '#2196f3';
                Chart.defaults.elements.point.borderColor = '#2196f3';
                Chart.defaults.elements.line.borderColor = '#2196f3';
                Chart.defaults.elements.bar.backgroundColor = '#2196f3';
                
                // Note: Scale-specific defaults are set per chart type in Chart.js v4
                // Global scale defaults are handled differently
            }
            
            // Add active class to current page navigation link
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const navLinks = document.querySelectorAll('.nav-menu a');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPage || (currentPage === '' && href === 'index.html')) {
                    link.classList.add('active');
                }
            });
        });
        
        // Enhanced Color palette for consistent styling (Light Blue to Grey)
        window.CVE_COLORS = window.CVE_COLORS || {
            primary: '#2196f3',
            secondary: '#64b5f6', 
            success: '#81c784',
            warning: '#ffb74d',
            danger: '#f06292',
            light: '#f8f9fa',
            dark: '#212529',
            
            // Light Blue to Grey Visualization Palette
            vizColors: [
                '#e3f2fd', // Very light blue
                '#bbdefb', // Light blue
                '#90caf9', // Medium light blue
                '#64b5f6', // Medium blue
                '#42a5f5', // Blue
                '#2196f3', // Primary blue
                '#1e88e5', // Darker blue
                '#1976d2', // Dark blue
                '#9e9e9e', // Medium grey
                '#757575'  // Dark grey
            ],
            
            // Chart-specific colors
            chartColors: [
                '#2196f3', // Primary blue
                '#64b5f6', // Secondary blue
                '#90caf9', // Tertiary blue
                '#bbdefb', // Quaternary blue
                '#81c784', // Accent green
                '#ffb74d', // Accent orange
                '#f06292', // Accent pink
                '#e0e0e0', // Light grey
                '#9e9e9e', // Medium grey
                '#616161'  // Dark grey
            ],
            
            // Gradient colors for backgrounds
            gradients: {
                primary: 'linear-gradient(135deg, #e3f2fd, #bbdefb)',
                secondary: 'linear-gradient(135deg, #bbdefb, #90caf9)',
                tertiary: 'linear-gradient(135deg, #90caf9, #64b5f6)'
            }
        };
        
        // Enhanced utility function to generate colors for charts
        function getChartColors(count, type = 'chart') {
            const colors = [];
            const palette = type === 'viz' ? CVE_COLORS.vizColors : CVE_COLORS.chartColors;
            
            for (let i = 0; i < count; i++) {
                colors.push(palette[i % palette.length]);
            }
            return colors;
        }
        
        // Generate light blue to grey gradient colors
        function getGradientColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const ratio = i / Math.max(count - 1, 1);
                // Interpolate between light blue and grey
                const r = Math.round(227 + (158 - 227) * ratio); // e3 to 9e
                const g = Math.round(242 + (158 - 242) * ratio); // f2 to 9e
                const b = Math.round(253 + (158 - 253) * ratio); // fd to 9e
                colors.push(`rgb(${r}, ${g}, ${b})`);
            }
            return colors;
        }
        
        // Get color with opacity
        function getColorWithOpacity(color, opacity = 0.8) {
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color;
        }
        
        // Utility function to format numbers
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Utility function to show loading state
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading data...</div>';
            }
        }
        
        // Utility function to hide loading state
        function hideLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const loading = container.querySelector('.loading');
                if (loading) {
                    loading.remove();
                }
            }
        }
        
        // Get current year for dynamic functionality
        const CURRENT_YEAR = new Date().getFullYear();
        const AVAILABLE_YEARS = [];
        for (let year = 1999; year <= CURRENT_YEAR; year++) {
            AVAILABLE_YEARS.push(year);
        }
        
        // Mobile table enhancement - add touch scroll indicators
        function enhanceMobileTable(tableContainer) {
            if (window.innerWidth <= 768 && tableContainer) {
                const table = tableContainer.querySelector('table');
                if (table && table.scrollWidth > tableContainer.clientWidth) {
                    tableContainer.style.overflowX = 'auto';
                    tableContainer.style.webkitOverflowScrolling = 'touch';
                    
                    // Add scroll shadow indicators
                    tableContainer.addEventListener('scroll', function() {
                        const scrollLeft = this.scrollLeft;
                        const maxScroll = this.scrollWidth - this.clientWidth;
                        
                        if (scrollLeft > 0) {
                            this.classList.add('scrolled-left');
                        } else {
                            this.classList.remove('scrolled-left');
                        }
                        
                        if (scrollLeft < maxScroll - 1) {
                            this.classList.add('scrolled-right');
                        } else {
                            this.classList.remove('scrolled-right');
                        }
                    });
                }
            }
        }
        
        // Apply mobile table enhancements on load
        document.addEventListener('DOMContentLoaded', function() {
            const tableContainers = document.querySelectorAll('.table-container');
            tableContainers.forEach(enhanceMobileTable);
            
            // Re-apply on window resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    tableContainers.forEach(enhanceMobileTable);
                }, 250);
            });
        });
    </script>
    
    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<style>
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sortable:hover {
    background-color: #f8f9fa;
}

.sort-indicator {
    font-size: 0.8em;
    margin-left: 5px;
    color: #6c757d;
}

.pagination {
    display: flex;
    list-style: none;
    margin: 0 auto;
    padding: 0;
    justify-content: center;
}

.pagination .page-item {
    display: inline-block;
}

.pagination .page-link {
    color: #0d6efd;
    padding: 0.375rem 0.75rem;
    margin-left: -1px;
    line-height: 1.25;
    text-decoration: none;
    background-color: #fff;
    border: 1px solid #dee2e6;
    display: block;
}

.pagination .page-link:hover {
    color: #0a58ca;
    background-color: #e9ecef;
    border-color: #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
}

.pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
    cursor: not-allowed;
}

.pagination .page-item:first-child .page-link {
    margin-left: 0;
    border-top-left-radius: 0.25rem;
    border-bottom-left-radius: 0.25rem;
}

.pagination .page-item:last-child .page-link {
    border-top-right-radius: 0.25rem;
    border-bottom-right-radius: 0.25rem;
}

.scorecard-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 1.1rem;
    opacity: 0.7;
    transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out;
}

.scorecard-link:hover {
    opacity: 1;
    transform: scale(1.1);
}

.filter-bar {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-surface);
    border-radius: var(--border-radius);
    border: 1px solid var(--color-border);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-label {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin: 0;
    white-space: nowrap;
}

.filter-select {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text-primary);
    font-size: 0.85rem;
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: var(--color-accent);
}

.filter-label input[type="checkbox"] {
    margin-right: 0.25rem;
    cursor: pointer;
}

.filter-summary {
    font-size: 0.85rem;
}
</style>

<script>
// Global variables
let cnaData = null;
let currentYearData = null;
let charts = {};
let currentDataMode = 'all'; // 'all' or 'current'

// Global state management
window.CNA_STATE = {
    dataMode: 'all',
    cnaData: null,
    currentYearData: null,
    charts: {}
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadCnaData();
    loadCurrentYearData();
});

function maybeInitializePage() {
    if (!cnaData || !currentYearData) {
        return;
    }
    initializePage();
}

// Load CNA data
function loadCnaData() {
    window.fetchJsonCached('/data/cna_analysis.json')
        .then(data => {
            cnaData = data;
            window.CNA_STATE.cnaData = data;
            maybeInitializePage();
        })
        .catch(error => {
            console.error('Error loading CNA data:', error);
            showErrorState();
        });
}

// Load current year data
function loadCurrentYearData() {
    window.fetchJsonCached('/data/cna_analysis_current_year.json')
        .then(data => {
            currentYearData = data;
            window.CNA_STATE.currentYearData = data;
            maybeInitializePage();
        })
        .catch(error => {
            console.error('Error loading current year CNA data:', error);
            showErrorState();
        });
}

// Initialize page after data is loaded
function initializePage() {
    updateStatistics();
    createCharts();
    generateInsights();
    populateTable(); // This calls renderTable() internally
}

// Get current data source based on mode
function getCurrentDataSource() {
    const mode = currentDataMode || window.CNA_STATE.dataMode;
    const result = mode === 'all' ? (cnaData || window.CNA_STATE.cnaData) : (currentYearData || window.CNA_STATE.currentYearData);
    return result;
}

// Process current year type distribution
function processCurrentYearTypeDistribution(yearData) {
    // For current year, we need to map CNA assigners to their types from the main data
    const typeDistribution = [];
    
    if (!yearData.cna_list || !cnaData.cna_list) {
        return typeDistribution;
    }
    
    const typeCounts = {};
    const totalCnas = yearData.cna_list.length;
    
    // Map current year CNAs to their types from the comprehensive data
    yearData.cna_list.forEach(cna => {
        const fullCnaInfo = cnaData.cna_list.find(c => c.name === cna.name);
        if (fullCnaInfo && fullCnaInfo.cna_types) {
            fullCnaInfo.cna_types.forEach(type => {
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
        }
    });
    
    // Convert to percentage format
    Object.entries(typeCounts).forEach(([type, count]) => {
        const percentage = totalCnas > 0 ? (count / totalCnas) * 100 : 0;
        typeDistribution.push({
            type: type,
            count: count,
            percentage: Math.round(percentage * 10) / 10
        });
    });
    
    return typeDistribution.sort((a, b) => b.percentage - a.percentage);
}

// Generate color gradient
function generateColorGradient(startColor, endColor, steps) {
    const colors = [];
    const start = hexToRgb(startColor);
    const end = hexToRgb(endColor);
    
    for (let i = 0; i < steps; i++) {
        const ratio = i / (steps - 1);
        const r = Math.round(start.r + ratio * (end.r - start.r));
        const g = Math.round(start.g + ratio * (end.g - start.g));
        const b = Math.round(start.b + ratio * (end.b - start.b));
        colors.push(`rgb(${r}, ${g}, ${b})`);
    }
    
    return colors;
}

// Convert hex to RGB
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

// Set data mode
function setDataMode(mode) {
    // Update both global variables and window state
    currentDataMode = mode;
    window.CNA_STATE.dataMode = mode;
    
    updateToggleUI();
    
    // Show/hide CNA Activity Status chart based on data mode
    const activityStatusContainer = document.getElementById('cnaActivityStatusContainer');
    if (activityStatusContainer) {
        if (currentDataMode === 'current') {
            // Hide in current year mode since all CNAs are active by definition
            activityStatusContainer.style.display = 'none';
        } else {
            // Show in all-time mode where active/inactive distinction is meaningful
            activityStatusContainer.style.display = 'block';
        }
    }
    
    // Refresh all visualizations with new data mode
    updateStatistics();
    createCharts();
    generateInsights();
    populateTable(); // This calls renderTable() internally
}

// Update toggle UI elements
function updateToggleUI() {
    const toggleText = document.getElementById('toggleText');
    const pageSubtitle = document.getElementById('pageSubtitle');
    
    if (currentDataMode === 'all') {
        toggleText.textContent = 'Switch to 2026 Only';
        pageSubtitle.textContent = 'Showing comprehensive analysis across all years (1999-2026)';
    } else {
        toggleText.textContent = 'Switch to All-Time';
        const currentYearNum = currentYearData && currentYearData.year ? currentYearData.year : new Date().getFullYear();
        pageSubtitle.textContent = `Showing analysis for ${currentYearNum} data only`;
    }
}

// Legacy functions for backward compatibility
function toggleDataMode() {
    const newMode = currentDataMode === 'all' ? 'current' : 'all';
    setDataMode(newMode);
}

function switchDataMode(mode) {
    setDataMode(mode);
}

// Update statistics cards
function updateStatistics() {
    const currentData = getCurrentDataSource();
    if (!currentData) return;
    
    let activeCnas, highVolumeCnas, totalCves, medianYearsActive, marketConcentration;
    
    if (currentDataMode === 'all') {
        // All-time data from comprehensive analysis
        if (!currentData.cna_list) return;
        
        activeCnas = currentData.cna_list.filter(cna => cna.activity_status === 'Active').length;
        highVolumeCnas = currentData.cna_list.filter(cna => cna.count >= 1000).length;
        totalCves = currentData.cna_list.reduce((sum, cna) => sum + cna.count, 0);
        
        // Calculate median years active
        const yearsActive = currentData.cna_list.map(cna => cna.years_active).sort((a, b) => a - b);
        const medianIndex = Math.floor(yearsActive.length / 2);
        medianYearsActive = yearsActive.length % 2 === 0 
            ? Math.round((yearsActive[medianIndex - 1] + yearsActive[medianIndex]) / 2)
            : yearsActive[medianIndex];
        
        // Calculate market concentration (top 5 CNAs' share)
        const top5Cves = currentData.cna_list.slice(0, 5).reduce((sum, cna) => sum + cna.count, 0);
        marketConcentration = ((top5Cves / totalCves) * 100).toFixed(1);
    } else {
        // Current year data
        if (!currentData.cna_list) return;
        
        activeCnas = currentData.cna_list.length;
        highVolumeCnas = currentData.cna_list.filter(cna => cna.count >= 1000).length;
        totalCves = currentData.total_cves || currentData.cna_list.reduce((sum, cna) => sum + cna.count, 0);
        
        // For current year, years active is always 1
        medianYearsActive = 1;
        
        // Calculate market concentration for current year
        const sortedCnas = currentData.cna_list.slice().sort((a, b) => b.count - a.count);
        const top5Cves = sortedCnas.slice(0, 5).reduce((sum, cna) => sum + cna.count, 0);
        marketConcentration = totalCves > 0 ? ((top5Cves / totalCves) * 100).toFixed(1) : '0.0';
    }
    
    document.getElementById('activeCnas').textContent = activeCnas.toLocaleString();
    document.getElementById('highVolumeCnas').textContent = highVolumeCnas.toLocaleString();
    document.getElementById('medianYearsActive').textContent = `${medianYearsActive} year${medianYearsActive !== 1 ? 's' : ''}`;
    document.getElementById('marketConcentration').textContent = `${marketConcentration}%`;
}

// Destroy existing charts
function destroyCharts() {
    Object.keys(charts).forEach(chartKey => {
        if (charts[chartKey]) {
            charts[chartKey].destroy();
            delete charts[chartKey];
        }
    });
}

// Create all charts
function createCharts() {
    // Destroy existing charts first
    destroyCharts();
    
    // Create new charts
    createTopCnasChart();
    createActivityChart();
    // createRecencyChart(); // Temporarily disabled
    createTypeChart();
    createVolumeChart();
    createKevChart();
    createGrowthChart();
}

// Top CNAs horizontal bar chart
function createTopCnasChart() {
    const ctx = document.getElementById('topCnasChart').getContext('2d');
    
    const currentData = getCurrentDataSource();
    if (!currentData) return;
    
    let topCnas, labels, data;
    
    if (currentDataMode === 'all') {
        if (!currentData.cna_list) return;
        topCnas = currentData.cna_list.slice(0, 15);
        labels = topCnas.map(cna => cna.name);
        data = topCnas.map(cna => cna.count);
    } else {
        if (!currentData.cna_list) return;
        // Sort current year CNAs by count and take top 15
        topCnas = currentData.cna_list
            .slice().sort((a, b) => b.count - a.count)
            .slice(0, 15);
        labels = topCnas.map(cna => cna.name);
        data = topCnas.map(cna => cna.count);
    }
    
    // Update chart subtitle to show current mode
    const subtitle = document.getElementById('topCnasSubtitle');
    if (subtitle) {
        if (currentDataMode === 'all') {
            subtitle.textContent = 'Showing top 15 CNAs by total CVE assignments (All-Time Data)';
        } else {
            const currentYearNum = currentYearData && currentYearData.year ? currentYearData.year : new Date().getFullYear();
            subtitle.textContent = `Showing top 15 CNAs by CVE assignments in ${currentYearNum} only`;
        }
    }
    
    charts.topCnas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'CVEs Assigned',
                data: data,
                backgroundColor: '#60a5fa',
                borderColor: '#3b82f6',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const cna = topCnas[context.dataIndex];
                            return [
                                `CVEs: ${context.parsed.x.toLocaleString()}`,
                                `Years Active: ${cna.years_active}`,
                                `Status: ${cna.activity_status}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                },
                y: {
                    ticks: {
                        autoSkip: false // Show all CNA labels
                    }
                }
            }
        }
    });
}



// CNA lifecycle stages chart
function createActivityChart() {
    const ctx = document.getElementById('cnaActivityChart').getContext('2d');
    
    const currentData = getCurrentDataSource();
    if (!currentData) return;
    
    let cnas;
    if (currentDataMode === 'all') {
        if (!currentData.cna_list) return;
        cnas = currentData.cna_list;
    } else {
        if (!currentData.cna_list) return;
        // Use the actual years_active values from current year data (now includes full history)
        cnas = currentData.cna_list;
    }
    
    const categories = {
        'Established (10+ years)': cnas.filter(cna => cna.years_active >= 10).length,
        'Mature (5-10 years)': cnas.filter(cna => cna.years_active >= 5 && cna.years_active < 10).length,
        'Growing (2-5 years)': cnas.filter(cna => cna.years_active >= 2 && cna.years_active < 5).length,
        'New (0-2 years)': cnas.filter(cna => cna.years_active < 2).length
    };
    
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    
    // Blue gradient from dark to light
    const colors = ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd'];
    
    charts.activity = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of CNAs',
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                            return `${context.parsed.x} CNAs (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Activity Recency Distribution chart
function createRecencyChart() {
    const canvasElement = document.getElementById('cnaRecencyChart');
    if (!canvasElement) {
        console.error('Canvas element cnaRecencyChart not found!');
        return;
    }
    const ctx = canvasElement.getContext('2d');
    
    const currentData = getCurrentDataSource();
    if (!currentData) {
        console.error('No currentData available for recency chart');
        return;
    }
    
    let cnas;
    if (currentDataMode === 'all') {
        console.log('createRecencyChart: all-time mode, cna_list length:', currentData.cna_list ? currentData.cna_list.length : 'undefined');
        if (!currentData.cna_list) {
            console.error('No cna_list available for all-time mode');
            return;
        }
        cnas = currentData.cna_list;
    } else {
        console.log('createRecencyChart: current year mode, cna_list length:', currentData.cna_list ? currentData.cna_list.length : 'undefined');
        if (!currentData.cna_list) {
            console.error('No cna_list available for current year mode');
            return;
        }
        // For current year, all CNAs are "Very Active" since they published in current year
        cnas = currentData.cna_list.map(cna => ({
            ...cna,
            days_since_last_cve: 0 // Current year CNAs are treated as very recent
        }));
    }
    
    console.log('createRecencyChart: processing', cnas.length, 'CNAs');
    console.log('Sample CNA for debugging:', cnas[0]);
    
    const categories = {
        'Very Active (0-30 days)': cnas.filter(cna => cna.days_since_last_cve <= 30).length,
        'Active (31-180 days)': cnas.filter(cna => cna.days_since_last_cve > 30 && cna.days_since_last_cve <= 180).length,
        'Moderate (181-365 days)': cnas.filter(cna => cna.days_since_last_cve > 180 && cna.days_since_last_cve <= 365).length,
        'Inactive (365+ days)': cnas.filter(cna => cna.days_since_last_cve > 365).length
    };
    
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    
    // Activity-based color gradient (blue to grey)
    const colors = ['#1e40af', '#3b82f6', '#60a5fa', '#6b7280'];
    
    charts.recency = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of CNAs',
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                            return `${context.parsed.x} CNAs (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// CNA type distribution chart
function createTypeChart() {
    const ctx = document.getElementById('cnaTypeChart').getContext('2d');
    
    const currentData = getCurrentDataSource();
    if (!currentData) return;
    
    let typeDistribution = [];
    
    if (currentDataMode === 'all') {
        // Use real type distribution data from comprehensive analysis
        if (currentData.type_distribution && currentData.type_distribution.sorted_types) {
            // Convert backend format to chart format
            typeDistribution = currentData.type_distribution.sorted_types.map(([type, count]) => ({
                type: type,
                count: count,
                percentage: currentData.type_distribution.type_percentages[type] || 0
            }));
            console.log('Loaded CNA type distribution:', typeDistribution);
        } else {
            console.log('No type distribution data available in all-time data');
            return;
        }
    } else {
        // For current year, calculate type distribution from individual CNA data
        if (!currentData.cna_list || currentData.cna_list.length === 0) {
            console.warn('No CNA data available for current year');
            return;
        }
        
        // Calculate type distribution from current year CNAs
        const typeCounts = {};
        const totalCnas = currentData.cna_list.length;
        
        currentData.cna_list.forEach(cna => {
            if (cna.cna_types && cna.cna_types.length > 0) {
                cna.cna_types.forEach(type => {
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
            } else {
                // Fallback for CNAs without type info
                typeCounts['Other'] = (typeCounts['Other'] || 0) + 1;
            }
        });
        
        // Convert to type distribution format and sort by count
        typeDistribution = Object.entries(typeCounts)
            .map(([type, count]) => ({
                type: type,
                count: count,
                percentage: parseFloat(((count / totalCnas) * 100).toFixed(1))
            }))
            .sort((a, b) => b.count - a.count);
        
        console.log('Calculated current year type distribution:', typeDistribution);
        
        if (typeDistribution.length === 0) {
            console.warn('No type distribution data calculated for current year');
            return;
        }
    }
    
    // Filter out N/A entries and prepare data
    const filteredDistribution = typeDistribution.filter(item => item.type !== 'N/A');
    const labels = filteredDistribution.map(item => item.type);
    const data = filteredDistribution.map(item => parseFloat(item.percentage.toFixed(1))); // Fix precision
    
    // Generate blue/grey color scheme to match site theme
    const colorPalette = [
        '#3b82f6', // Primary blue - Vendor (largest category)
        '#60a5fa', // Light blue - CERT
        '#93c5fd', // Lighter blue - Security Researcher
        '#bfdbfe', // Very light blue - Open Source
        '#6b7280', // Medium grey - Government
        '#9ca3af', // Light grey - Program
        '#d1d5db', // Very light grey - Other
        '#e5e7eb'  // Lightest grey - Academic
    ];
    const colors = colorPalette.slice(0, labels.length);
    
    charts.types = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Percentage of CNAs',
                data: data,
                backgroundColor: colors.map(color => color + '90'), // Add transparency
                borderColor: colors,
                borderWidth: 2,
                borderRadius: 4, // Rounded corners
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#374151',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            return `CNA Type: ${context[0].label}`;
                        },
                        label: function(context) {
                            const item = filteredDistribution[context.dataIndex];
                            return [
                                `Percentage: ${item.percentage}%`,
                                `Count: ${item.count.toLocaleString()} CNAs`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100, // Fixed scale to 100% for better readability
                    ticks: {
                        stepSize: 10, // Show ticks every 10%
                        callback: function(value) {
                            return Math.round(value) + '%'; // Round to avoid precision issues
                        },
                        font: {
                            size: 12
                        }
                    },
                    title: {
                        display: true,
                        text: 'Percentage of CNAs',
                        font: {
                            size: 13,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: '#e5e7eb',
                        lineWidth: 1
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: 12,
                            weight: '500'
                        },
                        color: '#374151'
                    },
                    grid: {
                        display: false // Remove horizontal grid lines for cleaner look
                    }
                }
            }
        }
    });
}

// CNA Performance Tiers (Volume) chart
function createVolumeChart() {
    const ctx = document.getElementById('cnaVolumeChart').getContext('2d');
    
    const currentData = getCurrentDataSource();
    if (!currentData) return;
    
    let cnas;
    if (currentDataMode === 'all') {
        if (!currentData.cna_list) return;
        cnas = currentData.cna_list;
    } else {
        if (!currentData.cna_list) return;
        cnas = currentData.cna_list;
    }
    
    const categories = {
        'High Volume (1000+ CVEs)': cnas.filter(cna => cna.count >= 1000).length,
        'Medium Volume (100-999 CVEs)': cnas.filter(cna => cna.count >= 100 && cna.count < 1000).length,
        'Low Volume (10-99 CVEs)': cnas.filter(cna => cna.count >= 10 && cna.count < 100).length,
        'Minimal Volume (1-9 CVEs)': cnas.filter(cna => cna.count >= 1 && cna.count < 10).length
    };
    
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    
    // Performance-based color gradient (dark to light blue)
    const colors = ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd'];
    
    charts.volume = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of CNAs',
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                            return `${context.parsed.x} CNAs (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// CNA KEV Chart - Top CNAs by Known Exploited Vulnerabilities
function createKevChart() {
    const ctx = document.getElementById('cnaKevChart');
    if (!ctx) return;
    
    const allTimeData = cnaData || window.CNA_STATE.cnaData;
    if (!allTimeData || !Array.isArray(allTimeData.cna_list)) {
        ctx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><small>No KEV data available</small></div>';
        return;
    }
    
    try {
        const cnaList = allTimeData.cna_list;
        
        // Filter CNAs with KEV CVEs and sort by kev_count
        const cnasWithKev = cnaList
            .filter(cna => cna.kev_count > 0)
            .sort((a, b) => b.kev_count - a.kev_count);
        
        if (cnasWithKev.length === 0) {
            ctx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><small>No KEV data available</small></div>';
            return;
        }
        
        const top10 = cnasWithKev.slice(0, 10);
        const labels = top10.map(cna => {
            return cna.name.length > 15 ? cna.name.substring(0, 15) + '...' : cna.name;
        });
        const dataValues = top10.map(cna => cna.kev_count);
        
        // Blue gradient matching site design
        const colors = ['#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', 
                       '#a8c8ec', '#9bc7e1', '#8cbfdc', '#7db7d7', '#6eafd2'];
        
        charts.kev = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'KEV CVEs',
                    data: dataValues,
                    backgroundColor: colors,
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const idx = context[0].dataIndex;
                                return top10[idx].name;
                            },
                            label: function(context) {
                                const idx = context.dataIndex;
                                const cna = top10[idx];
                                const kevRate = ((cna.kev_count / cna.count) * 100).toFixed(2);
                                return [
                                    `${context.parsed.x} known exploited CVEs`,
                                    `${kevRate}% of ${cna.count.toLocaleString()} total CVEs`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'KEV CVE Count'
                        }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
    } catch (error) {
        console.error('KEV chart error:', error);
        ctx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><small>Chart unavailable</small></div>';
    }
}

// CNA Growth Leaders - Most active CNAs in current year
function createGrowthChart() {
    const ctx = document.getElementById('cnaGrowthChart');
    if (!ctx) return;
    
    const currentData = currentYearData || window.CNA_STATE.currentYearData;
    if (!currentData || !Array.isArray(currentData.cna_list)) {
        ctx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><small>No current year data available</small></div>';
        return;
    }
    
    try {
        const cnaList = currentData.cna_list;
        
        if (cnaList.length === 0) {
            ctx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><small>No current year data available</small></div>';
            return;
        }
        
        // Sort by count and get top 10
        const top10 = cnaList.slice(0, 10);
        const labels = top10.map(cna => cna.name.length > 15 ? cna.name.substring(0, 15) + '...' : cna.name);
        const dataValues = top10.map(cna => cna.count);
        const displayYear = currentData.year || new Date().getFullYear();
        
        // Blue gradient matching site design
        const colors = ['#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', 
                       '#a8c8ec', '#9bc7e1', '#8cbfdc', '#7db7d7', '#6eafd2'];
        
        charts.growth = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'CVEs in ' + displayYear,
                    data: dataValues,
                    backgroundColor: colors,
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const idx = context[0].dataIndex;
                                return top10[idx].name;
                            },
                            label: function(context) {
                                return `${context.parsed.x.toLocaleString()} CVEs in ${displayYear}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: `CVEs (${displayYear})`
                        }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Growth chart error:', error);
        ctx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><small>Chart unavailable</small></div>';
    }
}

// Generate smart insights
function generateInsights() {
    const currentData = getCurrentDataSource();
    
    // Update total CNAs count in CVE V5 data source card
    const totalCnasElement = document.getElementById('totalCnasCount');
    if (totalCnasElement && currentData) {
        let totalCount = 0;
        if (currentDataMode === 'all' && currentData.cna_list) {
            totalCount = currentData.cna_list.length;
        } else if (currentDataMode === 'current' && currentData.cna_list) {
            totalCount = currentData.cna_list.length;
        }
        totalCnasElement.textContent = totalCount.toLocaleString();
    }
    
    if (!currentData) {
        console.error('generateInsights: No currentData available');
        return;
    }
    
    let cnas = [];
    if (currentDataMode === 'all' && currentData.cna_list) {
        cnas = currentData.cna_list;
    } else if (currentDataMode === 'current' && currentData.cna_list) {
        cnas = currentData.cna_list;
    }
    
    if (cnas.length === 0) {
        console.error('generateInsights: No CNAs available');
        return;
    }
    
    const totalCves = cnas.reduce((sum, cna) => sum + cna.count, 0);
    const topCna = cnas[0];
    
    if (currentDataMode === 'current') {
        // Current year specific insights
        const currentYear = currentYearData && currentYearData.year ? currentYearData.year : new Date().getFullYear();
        const topCnaShare = ((topCna.count / totalCves) * 100).toFixed(1);
        
        // Top current year CNA insight
        document.getElementById('marketLeaderInsight').innerHTML = `
            <strong>${topCna.name}</strong> leads ${currentYear} with <strong>${topCna.count.toLocaleString()}</strong> CVEs published (<strong>${topCnaShare}%</strong> of ${currentYear} volume)
        `;
        
        // Current year publication volume insight
        document.getElementById('activityInsight').innerHTML = `
            <strong>${totalCves.toLocaleString()}</strong> CVEs published in ${currentYear} by <strong>${cnas.length}</strong> active CNAs (averaging <strong>${Math.round(totalCves/cnas.length)}</strong> CVEs per CNA)
        `;
        
        // Experience mix insight - veteran vs new CNAs
        const veteranCnas = cnas.filter(cna => cna.years_active >= 10).length;
        const newCnas = cnas.filter(cna => cna.years_active <= 2).length;
        const longestActive = Math.max(...cnas.map(cna => cna.years_active));
        
        document.getElementById('orgTypeInsight').innerHTML = `
            <strong>${veteranCnas}</strong> veteran CNAs (10+ years) and <strong>${newCnas}</strong> newer CNAs (‚â§2 years) published in ${currentYear}, with <strong>${longestActive}</strong> years max experience
        `;
    } else {
        // All-time insights (original logic)
        const activeCnas = cnas.filter(cna => cna.activity_status === 'Active');
        const topCnaShare = ((topCna.count / totalCves) * 100).toFixed(1);
        
        // Top CNA insight
        document.getElementById('marketLeaderInsight').innerHTML = `
            <strong>${topCna.name}</strong> has assigned the most CVEs with <strong>${topCna.count.toLocaleString()}</strong> total assignments (<strong>${topCnaShare}%</strong> of all CVEs)
        `;
        
        // Activity status insight
        const activePercentage = ((activeCnas.length / cnas.length) * 100).toFixed(1);
        document.getElementById('activityInsight').innerHTML = `
            <strong>${activeCnas.length}</strong> of <strong>${cnas.length}</strong> CNAs are currently active (<strong>${activePercentage}%</strong>), having published CVEs within the last 12 months
        `;
        
        // Years active insight
        const avgYearsActive = Math.round(cnas.reduce((sum, cna) => sum + cna.years_active, 0) / cnas.length);
        const longestActive = Math.max(...cnas.map(cna => cna.years_active));
        
        document.getElementById('orgTypeInsight').innerHTML = `
            CNAs have been active for an average of <strong>${avgYearsActive} years</strong>, with the longest-running CNA active for <strong>${longestActive} years</strong>
        `;
    }
}

// Table pagination and sorting variables
let currentPage = 1;
let itemsPerPage = 25;
let currentSort = { field: 'last_cve_date', direction: 'desc' };
let sortedData = [];
let unfilteredData = []; // Original data before filters

// Filter state
let activeFilters = {
    type: '',
    status: '',
    hasKev: false,
    highVolume: false
};

// Apply filters to the CNA data
function applyFilters() {
    activeFilters = {
        type: document.getElementById('filterType').value,
        status: document.getElementById('filterStatus').value,
        hasKev: document.getElementById('filterKev').checked,
        highVolume: document.getElementById('filterHighVolume').checked
    };
    
    // Filter the unfiltered data
    let filtered = unfilteredData.filter(cna => {
        // Type filter
        if (activeFilters.type && (!cna.cna_types || !cna.cna_types.includes(activeFilters.type))) {
            return false;
        }
        // Status filter
        if (activeFilters.status && cna.activity_status !== activeFilters.status) {
            return false;
        }
        // KEV filter
        if (activeFilters.hasKev && (!cna.kev_count || cna.kev_count === 0)) {
            return false;
        }
        // High volume filter
        if (activeFilters.highVolume && cna.count < 1000) {
            return false;
        }
        return true;
    });
    
    // Apply current sort to filtered data
    sortedData = [...filtered].sort((a, b) => {
        let aVal, bVal;
        
        // Handle rank specially - use the rank property
        if (currentSort.field === 'rank') {
            aVal = a.rank || 999;
            bVal = b.rank || 999;
            return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        aVal = a[currentSort.field];
        bVal = b[currentSort.field];
        
        if (currentSort.field === 'last_cve_date') {
            const aDate = new Date(aVal);
            const bDate = new Date(bVal);
            return currentSort.direction === 'asc' ? aDate - bDate : bDate - aDate;
        }
        
        if (currentSort.field === 'name') {
            aVal = (aVal || '').toLowerCase();
            bVal = (bVal || '').toLowerCase();
        }
        
        if (typeof aVal === 'string') {
            return currentSort.direction === 'asc' 
                ? aVal.localeCompare(bVal) 
                : bVal.localeCompare(aVal);
        }
        
        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });
    
    // Reset to first page when filters change
    currentPage = 1;
    
    // Update filter summary
    const hasActiveFilters = activeFilters.type || activeFilters.status || activeFilters.hasKev || activeFilters.highVolume;
    const filterSummary = document.getElementById('filterSummary');
    if (hasActiveFilters) {
        filterSummary.style.display = 'block';
        document.getElementById('filteredCount').textContent = sortedData.length;
    } else {
        filterSummary.style.display = 'none';
    }
    
    renderTable();
}

// Reset all filters
function resetFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterKev').checked = false;
    document.getElementById('filterHighVolume').checked = false;
    applyFilters();
}

// Populate CNA table with pagination and sorting
function populateTable() {
    const currentData = getCurrentDataSource();
    if (!currentData) {
        console.error('populateTable: No currentData available');
        return;
    }
    
    let dataToSort;
    
    if (currentDataMode === 'all') {
        console.log('populateTable: all-time mode');
        if (!currentData.cna_list) {
            console.error('populateTable: No cna_list in all-time data');
            return;
        }
        dataToSort = currentData.cna_list;
        console.log('populateTable: dataToSort length (all-time):', dataToSort.length);
    } else {
        console.log('populateTable: current year mode');
        if (!currentData.cna_list) {
            console.error('populateTable: No cna_list in current year data');
            return;
        }
        // Use real CVE dates from backend data - no hardcoded overrides
        dataToSort = currentData.cna_list.map(cna => ({
            ...cna,
            // Keep the real last_cve_date from backend data
            activity_status: 'Active' // All current year CNAs are active
        }));
        console.log('populateTable: dataToSort length (current year):', dataToSort.length);
    }
    
    // Store unfiltered data for filter operations
    unfilteredData = [...dataToSort];
    
    // Set initial sort state to match default (rank ascending)
    currentSort = {
        field: 'rank',
        direction: 'asc'
    };
    
    // Apply filters (this also handles sorting and rendering)
    applyFilters();
    
    setupSortingHandlers();
    updateSortIndicators(); // Show correct default sort indicator
}

// Render table with current page and sorting
function renderTable() {
    const tbody = document.getElementById('cnaTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = sortedData.slice(startIndex, endIndex);
    
    const rows = pageData.map((cna, index) => {
        let formattedDate = 'Invalid Date';
        if (cna.last_cve_date) {
            const lastCveDate = new Date(cna.last_cve_date);
            if (!isNaN(lastCveDate.getTime())) {
                formattedDate = lastCveDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } else {
                console.error('Invalid date for CNA:', cna.name, 'date:', cna.last_cve_date);
                formattedDate = 'Invalid Date';
            }
        }
        const statusColor = cna.activity_status === 'Active' ? '#10b981' : '#ef4444';
        const statusIcon = cna.activity_status === 'Active' ? '‚úÖ' : '‚ùå';
        // Use rank from JSON data, not recalculated
        let displayRank = cna.rank || (index + 1);
        // Generate CNAScorecard link
        const scorecardUrl = `https://cnascorecard.org/cna/cna-detail.html?shortName=${encodeURIComponent(cna.name)}`;
        return `
            <tr>
                <td><strong>#${displayRank}</strong></td>
                <td>${cna.name}</td>
                <td>${cna.count.toLocaleString()}</td>
                <td>${cna.years_active} years</td>
                <td>${formattedDate}</td>
                <td><span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${cna.activity_status}</span></td>
                <td><a href="${scorecardUrl}" target="_blank" rel="noopener noreferrer" title="View on CNAScorecard" class="scorecard-link">üìä</a></td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = rows;
    updatePaginationInfo();
    updatePaginationControls();
}

// Update pagination info text
function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, sortedData.length);
    const totalItems = sortedData.length;
    
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex}-${endIndex} of ${totalItems} CNAs`;
}

// Update pagination controls
function updatePaginationControls() {
    const totalPages = Math.ceil(sortedData.length / itemsPerPage);
    const paginationControls = document.getElementById('paginationControls');
    
    if (totalPages <= 1) {
        paginationControls.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    paginationHTML += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" id="prevPage">&laquo;</a></li>`;
    
    // Always show first page
    if (currentPage > 3) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
        if (currentPage > 4) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    // Show pages around current page
    const startPage = Math.max(1, currentPage - 1);
    const endPage = Math.min(totalPages, currentPage + 1);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === currentPage ? 'active' : '';
        paginationHTML += `<li class="page-item ${active}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
    
    // Always show last page
    if (currentPage < totalPages - 2) {
        if (currentPage < totalPages - 3) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
    }
    
    // Next button
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    paginationHTML += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" id="nextPage">&raquo;</a></li>`;
    
    paginationControls.innerHTML = paginationHTML;
    
    // Add event listeners for pagination
    setupPaginationHandlers();
}

// Setup pagination event handlers
function setupPaginationHandlers() {
    const paginationControls = document.getElementById('paginationControls');
    // Remove all previous listeners by replacing the element
    const newControls = paginationControls.cloneNode(true);
    paginationControls.parentNode.replaceChild(newControls, paginationControls);
    newControls.addEventListener('click', (e) => {
        e.preventDefault();
        const target = e.target;
        if (!target.classList.contains('page-link')) return;
        if (target.id === 'prevPage') {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
            return;
        }
        if (target.id === 'nextPage') {
            const totalPages = Math.ceil(sortedData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
            return;
        }
        const page = parseInt(target.getAttribute('data-page'));
        if (page && page !== currentPage) {
            currentPage = page;
            renderTable();
        }
    });
}

// Track if handlers are already set up to prevent duplicates
let sortHandlersSetup = false;

// Setup sorting event handlers
function setupSortingHandlers() {
    // Only set up handlers once
    if (sortHandlersSetup) {
        return;
    }
    
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const sortField = header.getAttribute('data-sort');
            
            // Toggle direction if same field, otherwise default to ascending
            if (currentSort.field === sortField) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = sortField;
                currentSort.direction = sortField === 'last_cve_date' ? 'desc' : 'asc';
            }
            
            // Use applyFilters which handles both filtering and sorting
            applyFilters();
            updateSortIndicators();
        });
    });
    
    sortHandlersSetup = true;
}

// Sort data based on current sort settings
function sortData() {
    sortedData.sort((a, b) => {
        let valueA, valueB;
        
        switch (currentSort.field) {
            case 'rank':
                valueA = cnaData.cna_list.findIndex(original => original.name === a.name) + 1;
                valueB = cnaData.cna_list.findIndex(original => original.name === b.name) + 1;
                break;
            case 'name':
                valueA = a.name.toLowerCase();
                valueB = b.name.toLowerCase();
                break;
            case 'count':
                valueA = a.count;
                valueB = b.count;
                break;
            case 'years_active':
                valueA = a.years_active;
                valueB = b.years_active;
                break;
            case 'last_cve_date':
                valueA = new Date(a.last_cve_date);
                valueB = new Date(b.last_cve_date);
                break;
            case 'activity_status':
                valueA = a.activity_status;
                valueB = b.activity_status;
                break;
            default:
                return 0;
        }
        
        let comparison = 0;
        if (valueA > valueB) comparison = 1;
        if (valueA < valueB) comparison = -1;
        
        return currentSort.direction === 'desc' ? -comparison : comparison;
    });
}

// Update sort indicators in table headers
function updateSortIndicators() {
    document.querySelectorAll('.sort-indicator').forEach(indicator => {
        indicator.textContent = '';
    });
    const activeHeader = document.querySelector(`[data-sort="${currentSort.field}"] .sort-indicator`);
    if (activeHeader) {
        activeHeader.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
    }
}

// Permalink functionality
function generatePermalink() {
    const permalink = `${window.location.origin}${window.location.pathname}`;
    
    const resultDiv = document.getElementById('permalinkResult');
    const input = document.getElementById('permalinkInput');
    
    input.value = permalink;
    resultDiv.style.display = 'block';
}

function copyPermalink() {
    const input = document.getElementById('permalinkInput');
    input.select();
    document.execCommand('copy');
    
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.style.backgroundColor = '#198754';
    
    setTimeout(() => {
        button.textContent = originalText;
        button.style.backgroundColor = '';
    }, 2000);
}

// Export functions
function exportCnaCSV() {
    if (!cnaData || !cnaData.cna_list) {
        alert('No data available for export');
        return;
    }
    
    const totalCves = cnaData.cna_list.reduce((sum, cna) => sum + cna.count, 0);
    const activeCnas = cnaData.cna_list.filter(cna => cna.activity_status === 'Active').length;
    
    let csv = 'CNA Intelligence Dashboard Export\n\n';
    csv += 'Rank,CNA Name,Official Status,CVEs Assigned,Years Active,Last CVE Date,Activity Status\n';
    
    cnaData.cna_list.forEach((cna, index) => {
        const lastCveDate = new Date(cna.last_cve_date).toLocaleDateString('en-US');
        const officialStatus = cna.is_official !== false ? 'Official' : 'Unofficial';
        csv += `${index + 1},"${cna.name}",${officialStatus},${cna.count},${cna.years_active},${lastCveDate},${cna.activity_status}\n`;
    });
    
    csv += '\n\nSummary Statistics\n';
    csv += `Total CNAs,${cnaData.cna_list.length}\n`;
    csv += `Active CNAs,${activeCnas}\n`;
    csv += `Inactive CNAs,${cnaData.cna_list.length - activeCnas}\n`;
    csv += `Total CVEs Assigned,${totalCves.toLocaleString()}\n`;
    csv += `Average CVEs per CNA,${Math.round(totalCves / cnaData.cna_list.length)}\n`;
    
    downloadFile(csv, 'cna-comprehensive-analysis.csv', 'text/csv');
}

function exportCnaJSON() {
    if (!cnaData) {
        alert('No data available for export');
        return;
    }
    const totalCves = cnaData.cna_list.reduce((sum, cna) => sum + cna.count, 0);
    const activeCnas = cnaData.cna_list.filter(cna => cna.activity_status === 'Active').length;
    const exportData = {
        metadata: {
            averageCvesPerCna: Math.round(totalCves / cnaData.cna_list.length),
            totalCnas: cnaData.cna_list.length,
            activeCnas: activeCnas,
            inactiveCnas: cnaData.cna_list.length - activeCnas,
            totalCves: totalCves
        }
    };
    const jsonStr = JSON.stringify(exportData, null, 2);
    downloadFile(jsonStr, 'cna-comprehensive-analysis.json', 'application/json');
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Error state
function showErrorState() {
    document.getElementById('activeCnas').textContent = 'Error';
    document.getElementById('highVolumeCnas').textContent = 'Error';
    document.getElementById('medianYearsActive').textContent = 'Error';
    document.getElementById('marketConcentration').textContent = 'Error';
    document.getElementById('cnaTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading CNA data. Please refresh the page.</td></tr>';
}
</script>

</body>
</html>