{% extends "base.html" %}

{% block title %}CVE.ICU - CVE Analysis Dashboard{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="text-center mb-5">
    <h1 class="mb-3">CVE.ICU</h1>
    <p class="text-muted">Advanced vulnerability intelligence platform delivering comprehensive CVE analytics from 1999 to {{ current_year if current_year else '2025' }}</p>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="cves-this-year">Loading...</div>
        <div class="stat-label">CVEs This Year</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="avg-cves-per-day">Loading...</div>
        <div class="stat-label">Avg CVEs/Day</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="growth-rate">Loading...</div>
        <div class="stat-label">YOY Growth</div>
        <div class="stat-detail" id="growth-detail">Loading...</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="total-cves">Loading...</div>
        <div class="stat-label">Total CVEs</div>
    </div>
</div>

<!-- Featured Visualization: CVEs by Year -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title mb-0">üìä CVE Publications by Year</h3>
        <small class="text-muted">Historical trend of vulnerability disclosures from 1999 to present</small>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 400px;">
            <canvas id="cvesByYearChart"></canvas>
        </div>
        <div class="text-center mt-3">
            <small class="text-muted">Interactive visualization showing annual CVE publication trends</small>
        </div>
    </div>
</div>

<!-- Dashboard Previews -->

<!-- Growth Preview -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="card-title mb-0">üìà Growth</h4>
        <small class="text-muted">Year-over-year CVE publication trends and growth analysis</small>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="growthPreviewChart"></canvas>
        </div>
        <div class="text-center mt-3">
            <a href="growth.html" class="btn btn-primary btn-sm">View Full Dashboard ‚Üí</a>
        </div>
    </div>
</div>

<!-- CVSS Preview -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="card-title mb-0">üéØ CVSS</h4>
        <small class="text-muted">Vulnerability severity scoring analysis across all CVSS versions</small>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="cvssPreviewChart"></canvas>
        </div>
        <div class="text-center mt-3">
            <a href="cvss.html" class="btn btn-primary btn-sm">View Full Dashboard ‚Üí</a>
        </div>
    </div>
</div>

<!-- CWE Preview -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="card-title mb-0">üîç CWE</h4>
        <small class="text-muted">Common Weakness Enumeration patterns and vulnerability types</small>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="cwePreviewChart"></canvas>
        </div>
        <div class="text-center mt-3">
            <a href="cwe.html" class="btn btn-primary btn-sm">View Full Dashboard ‚Üí</a>
        </div>
    </div>
</div>

<!-- CNA Preview -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="card-title mb-0">üè¢ CNA</h4>
        <small class="text-muted">CVE Numbering Authority activity and organizational analysis</small>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="cnaPreviewChart"></canvas>
        </div>
        <div class="text-center mt-3">
            <a href="cna.html" class="btn btn-primary btn-sm">View Full Dashboard ‚Üí</a>
        </div>
    </div>
</div>

<!-- CPE Preview -->
<div class="card mb-4">
    <div class="card-header">
        <h4 class="card-title mb-0">üíª CPE</h4>
        <small class="text-muted">Common Platform Enumeration and affected technology analysis</small>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="cpePreviewChart"></canvas>
        </div>
        <div class="text-center mt-3">
            <a href="cpe.html" class="btn btn-primary btn-sm">View Full Dashboard ‚Üí</a>
        </div>
    </div>
</div>

<!-- About Section -->
<div class="card mt-5">
    <div class="card-header">
        <h3 class="card-title mb-0">About CVE.ICU</h3>
    </div>
    <div class="card-body">
        <p class="mb-4">CVE.ICU provides comprehensive vulnerability intelligence through advanced analytics and visualization of Common Vulnerabilities and Exposures (CVE) data spanning {{ available_years|length if available_years else '27' }} years of cybersecurity history from 1999 to {{ current_year if current_year else '2025' }}.</p>
        
        <div class="row">
            <div class="col-md-6">
                <h4>Platform Capabilities</h4>
                <ul class="mb-4">
                    <li><strong>Comprehensive Coverage:</strong> Complete historical CVE dataset with continuous updates</li>
                    <li><strong>Advanced Analytics:</strong> Interactive dashboards with dynamic data visualization</li>
                    <li><strong>Real-Time Intelligence:</strong> Automated data refresh every 6 hours</li>
                    <li><strong>Scalable Architecture:</strong> Self-expanding system accommodating future data</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h4>Data Infrastructure</h4>
                <ul class="mb-4">
                    <li><strong>Primary Source:</strong> NIST National Vulnerability Database (NVD)</li>
                    <li><strong>Processing Pipeline:</strong> Automated ingestion and normalization</li>
                    <li><strong>Historical Repository:</strong> Complete vulnerability records archive</li>
                    <li><strong>Update Frequency:</strong> Continuous 6-hour synchronization cycle</li>
                </ul>
            </div>
        </div>
        
        <div class="text-center">
            <div class="alert alert-info" style="background-color: rgba(13, 110, 253, 0.1); border: 1px solid rgba(13, 110, 253, 0.2); border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem;">
                <p class="mb-0"><strong>Automated Intelligence Platform:</strong> CVE.ICU operates on a fully automated infrastructure that ensures continuous data availability and seamless expansion. The system is engineered to automatically incorporate new vulnerability data as it becomes available, requiring zero manual intervention for ongoing operations.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Wait for Chart.js and CVE_COLORS to be available
    if (typeof Chart === 'undefined' || typeof window.CVE_COLORS === 'undefined') {
        console.error('Chart.js or CVE_COLORS not loaded');
        return;
    }
    
    // Initialize CVEs by Year Chart
    const ctx = document.getElementById('cvesByYearChart');
    if (ctx) {
        // Sample data - this would be populated by the Python backend
        const yearlyData = {
            labels: [],
            datasets: [{
                label: 'CVEs Published',
                data: [],
                borderColor: window.CVE_COLORS.primary,
                backgroundColor: window.CVE_COLORS.primaryLight,
                fill: false,
                tension: 0.1
            }]
        };
        
        // Load actual CVE data from JSON files
        const currentYear = new Date().getFullYear();
        const loadPromises = [];
        
        // Generate years from 1999 to current year and load data
        for (let year = 1999; year <= currentYear; year++) {
            yearlyData.labels.push(year.toString());
            
            // Load actual CVE data for each year
            const promise = fetch(`data/cve_${year}.json`)
                .then(response => {
                    if (!response.ok) {
                        console.warn(`No data found for year ${year}`);
                        return { total_cves: 0 };
                    }
                    return response.json();
                })
                .then(data => {
                    return { year: year, count: data.total_cves || 0 };
                })
                .catch(error => {
                    console.warn(`Error loading data for year ${year}:`, error);
                    return { year: year, count: 0 };
                });
            
            loadPromises.push(promise);
        }
        
        // Wait for all data to load, then create the chart and update stats
        Promise.all(loadPromises).then(results => {
            // Sort results by year to ensure correct order
            results.sort((a, b) => a.year - b.year);
            
            // Extract the CVE counts in the correct order
            yearlyData.datasets[0].data = results.map(result => result.count);
            
            // Calculate and update statistics
            updateStatistics(results);
            
            // Create the chart with real data
            createChart();
        }).catch(error => {
            console.error('Error loading CVE data:', error);
            // Fallback: create chart with empty data and show error in stats
            updateStatisticsError();
            createChart();
        });
        
        function updateStatistics(results) {
            try {
                // Calculate total CVEs
                const totalCves = results.reduce((sum, result) => sum + result.count, 0);
                document.getElementById('total-cves').textContent = totalCves.toLocaleString();
                
                // Calculate CVEs this year (current year)
                const currentYear = new Date().getFullYear();
                const currentYearData = results.find(r => r.year === currentYear);
                const cvesThisYear = currentYearData ? currentYearData.count : 0;
                document.getElementById('cves-this-year').textContent = cvesThisYear.toLocaleString();
                
                // Calculate average CVEs per day (based on current year)
                const dayOfYear = Math.floor((new Date() - new Date(currentYear, 0, 0)) / (1000 * 60 * 60 * 24));
                const avgCvesPerDay = cvesThisYear > 0 && dayOfYear > 0 ? (cvesThisYear / dayOfYear).toFixed(1) : '0';
                document.getElementById('avg-cves-per-day').textContent = avgCvesPerDay;
                
                // Calculate YTD growth rate (current year YTD vs same period last year)
                const prevYearData = results.find(r => r.year === currentYear - 1);
                const prevYearCount = prevYearData ? prevYearData.count : 0;
                
                if (prevYearCount > 0) {
                    // Calculate same period last year (YTD comparison)
                    const dayOfYear = Math.floor((new Date() - new Date(currentYear, 0, 0)) / (1000 * 60 * 60 * 24));
                    const yearProgress = dayOfYear / 365; // Approximate year progress
                    const prevYearYtdEstimate = Math.round(prevYearCount * yearProgress);
                    
                    const growthRate = prevYearYtdEstimate > 0 ? ((cvesThisYear - prevYearYtdEstimate) / prevYearYtdEstimate) * 100 : 0;
                    const growthText = growthRate >= 0 ? `+${growthRate.toFixed(1)}%` : `${growthRate.toFixed(1)}%`;
                    document.getElementById('growth-rate').textContent = growthText;
                    document.getElementById('growth-detail').textContent = `${cvesThisYear.toLocaleString()} vs ${prevYearYtdEstimate.toLocaleString()} (YTD vs Same Period ${currentYear - 1})`;
                } else {
                    document.getElementById('growth-rate').textContent = 'N/A';
                    document.getElementById('growth-detail').textContent = 'No previous year data';
                }
            } catch (error) {
                console.error('Error updating statistics:', error);
                updateStatisticsError();
            }
        }
        
        function updateStatisticsError() {
            document.getElementById('total-cves').textContent = 'Error';
            document.getElementById('cves-this-year').textContent = 'Error';
            document.getElementById('avg-cves-per-day').textContent = 'Error';
            document.getElementById('growth-rate').textContent = 'Error';
            document.getElementById('growth-detail').textContent = 'Error loading data';
        }
        
        function createChart() {
            new Chart(ctx, {
                type: 'line',
                data: yearlyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'CVE Publications by Year',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of CVEs'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6
                        }
                    }
                }
            });
        }
    }
    
    // Initialize Intelligence Dashboard Preview Charts
    initializePreviewCharts();
});

function initializePreviewCharts() {
    // Growth Intelligence Preview Chart
    const growthPreviewCtx = document.getElementById('growthPreviewChart');
    if (growthPreviewCtx) {
        fetch('data/growth_analysis.json')
            .then(response => response.json())
            .then(data => {
                const growthData = data.growth_data || [];
                const labels = [];
                const growthRates = [];
                
                // Show all years of data (exclude current year as it's YTD)
                const allData = growthData.filter(item => item.year !== new Date().getFullYear());
                allData.forEach(item => {
                    labels.push(item.year.toString());
                    growthRates.push(item.growth_rate || 0);
                });
                
                new Chart(growthPreviewCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: growthRates,
                            borderColor: '#6c9bd1',
                            backgroundColor: 'rgba(108, 155, 209, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Growth: ${context.parsed.y >= 0 ? '+' : ''}${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Growth Rate (%)'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Year'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        },
                        elements: {
                            point: { radius: 2 }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading growth preview data:', error);
                growthPreviewCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><small>Preview unavailable</small></div>';
            });
    }
    
    // CVSS Intelligence Preview Chart
    const cvssPreviewCtx = document.getElementById('cvssPreviewChart');
    if (cvssPreviewCtx) {
        fetch('data/cvss_analysis.json')
            .then(response => response.json())
            .then(data => {
                // Aggregate severity data across all CVSS versions
                const aggregatedSeverity = {};
                const severityDistribution = data.severity_distribution || {};
                
                Object.values(severityDistribution).forEach(versionData => {
                    Object.entries(versionData).forEach(([severity, count]) => {
                        aggregatedSeverity[severity] = (aggregatedSeverity[severity] || 0) + count;
                    });
                });
                
                const labels = Object.keys(aggregatedSeverity);
                const values = Object.values(aggregatedSeverity);
                
                new Chart(cvssPreviewCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: '#6c9bd1',
                            borderColor: '#5a8bc4',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'CVE Count'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Severity Level'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading CVSS preview data:', error);
                cvssPreviewCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><small>Preview unavailable</small></div>';
            });
    }
    
    // CWE Intelligence Preview Chart
    const cwePreviewCtx = document.getElementById('cwePreviewChart');
    if (cwePreviewCtx) {
        fetch('data/cwe_analysis.json')
            .then(response => response.json())
            .then(data => {
                const cweData = data.top_cwes || [];
                const topCWEs = cweData.slice(0, 5); // Top 5 CWEs
                const labels = topCWEs.map(item => `CWE-${item.id}`);
                const values = topCWEs.map(item => item.count);
                
                new Chart(cwePreviewCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: '#6c9bd1',
                            borderColor: '#5a8bc4',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'CVE Count'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'CWE Type'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading CWE preview data:', error);
                cwePreviewCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><small>Preview unavailable</small></div>';
            });
    }
    
    // CNA Intelligence Preview Chart
    const cnaPreviewCtx = document.getElementById('cnaPreviewChart');
    if (cnaPreviewCtx) {
        fetch('data/cna_analysis.json')
            .then(response => response.json())
            .then(data => {
                const cnaData = data.cna_assigners || [];
                const topCNAs = cnaData.slice(0, 5); // Top 5 CNAs
                const labels = topCNAs.map(item => item.name.length > 15 ? item.name.substring(0, 15) + '...' : item.name);
                const values = topCNAs.map(item => item.count);
                
                new Chart(cnaPreviewCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: '#6c9bd1',
                            borderColor: '#5a8bc4',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'CNA Organization'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'CVE Count'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading CNA preview data:', error);
                cnaPreviewCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><small>Preview unavailable</small></div>';
            });
    }
    
    // CPE Intelligence Preview Chart
    const cpePreviewCtx = document.getElementById('cpePreviewChart');
    if (cpePreviewCtx) {
        fetch('data/cpe_analysis.json')
            .then(response => response.json())
            .then(data => {
                const cpeData = data.top_cpes || [];
                const topCPEs = cpeData.slice(0, 5); // Top 5 CPEs
                const labels = topCPEs.map(item => item.vendor.length > 12 ? item.vendor.substring(0, 12) + '...' : item.vendor);
                const values = topCPEs.map(item => item.count);
                
                new Chart(cpePreviewCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: '#6c9bd1',
                            borderColor: '#5a8bc4',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'CVE Count'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Vendor'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading CPE preview data:', error);
                cpePreviewCtx.parentElement.innerHTML = '<div class="text-center text-muted py-4"><small>Preview unavailable</small></div>';
            });
    }
}
</script>
{% endblock %}
