{% extends "base.html" %}

{% block title %}CVE Year Analysis - CVE.ICU{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ“Š CVE Year Analysis</h1>
    <p class="page-subtitle">
        Interactive comparison and analysis of CVE data across {{ available_years|length }} years (1999-{{ current_year }})
    </p>
    <div class="stats-overview" id="statsOverview">
        <div class="stat-item">
            <span class="stat-number" id="totalCvesGlobal">Loading...</span>
            <span class="stat-label">Total CVEs</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="yearsAvailable">{{ available_years|length }}</span>
            <span class="stat-label">Years Available</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="avgPerYear">Loading...</span>
            <span class="stat-label">Avg per Year</span>
        </div>
    </div>
</div>

<div class="year-controls">
    <h3>ğŸ¯ Select Years to Compare</h3>
    <div class="controls-section">
        <div class="quick-select">
            <button class="btn btn-primary" onclick="selectRecentYears()" title="Select last 5 years">ğŸ“… Recent (5y)</button>
            <button class="btn btn-secondary" onclick="selectDecade(2020)" title="Select 2020-2025">ğŸ“Š 2020s</button>
            <button class="btn btn-secondary" onclick="selectDecade(2010)" title="Select 2010-2019">ğŸ“ˆ 2010s</button>
            <button class="btn btn-secondary" onclick="selectDecade(2000)" title="Select 2000-2009">ğŸ“‰ 2000s</button>
            <button class="btn btn-secondary" onclick="selectAllYears()" title="Select all available years">ğŸŒ All Years</button>
            <button class="btn btn-outline" onclick="clearAllYears()" title="Clear all selections">âŒ Clear</button>
        </div>
        <div class="year-range">
            <label>ğŸ“… Custom Range:</label>
            <select id="startYear" onchange="updateYearRange()" title="Select start year">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == current_year - 4 %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
            <span class="range-separator">to</span>
            <select id="endYear" onchange="updateYearRange()" title="Select end year">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-sm btn-primary" onclick="applyYearRange()" title="Apply selected range">Apply Range</button>
        </div>
    </div>
    <div class="year-selector" id="yearSelector">
        {% for year in available_years %}
        <label class="year-checkbox">
            <input type="checkbox" value="{{ year }}" {% if year >= current_year - 2 %}checked{% endif %}>
            <span class="year-label">{{ year }}</span>
        </label>
        {% endfor %}
    </div>
    <div class="selection-info">
        <div class="selection-stats">
            <span class="stat-badge" id="selectionCount">3 years selected</span>
            <span class="stat-badge" id="totalCves">Loading CVE counts...</span>
            <span class="stat-badge" id="dateRange">Loading date range...</span>
        </div>
        <div class="selection-actions">
            <button class="btn btn-sm btn-outline" onclick="exportSelection()" title="Export selected data">ğŸ“¥ Export</button>
            <button class="btn btn-sm btn-outline" onclick="shareSelection()" title="Share selection URL">ğŸ”— Share</button>
        </div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart-container chart-full">
        <div class="chart-header">
            <h3>ğŸ“ˆ CVE Trends Over Time</h3>
            <div class="chart-controls">
                <select id="trendViewType" onchange="updateTrendView()">
                    <option value="absolute">Absolute Count</option>
                    <option value="cumulative">Cumulative</option>
                    <option value="growth">Growth Rate %</option>
                </select>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="yearComparisonChart"></canvas>
        </div>
    </div>

    <div class="chart-container chart-half">
        <div class="chart-header">
            <h3>ğŸ“… Monthly Distribution</h3>
            <div class="chart-controls">
                <select id="monthlyViewType" onchange="updateMonthlyView()">
                    <option value="stacked">Stacked</option>
                    <option value="grouped">Grouped</option>
                    <option value="average">Average</option>
                </select>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <div class="chart-container chart-half">
        <div class="chart-header">
            <h3>âš ï¸ CVSS Severity Distribution</h3>
            <div class="chart-controls">
                <select id="severityViewType" onchange="updateSeverityView()">
                    <option value="combined">All Versions</option>
                    <option value="by_version">By CVSS Version</option>
                    <option value="evolution">Evolution</option>
                </select>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="severityChart"></canvas>
        </div>
    </div>

    <div class="chart-container chart-half">
        <div class="chart-header">
            <h3>ğŸ¢ Top Vendors (CNA)</h3>
            <div class="chart-controls">
                <span class="chart-info">Top 10 CNA assigners</span>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="vendorChart"></canvas>
        </div>
    </div>

    <div class="chart-container chart-half">
        <div class="chart-header">
            <h3>ğŸ” Top Weaknesses (CWE)</h3>
            <div class="chart-controls">
                <span class="chart-info">Most common CWEs</span>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="cweChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced year comparison functionality with data caching
let yearComparisonChart = null;
let monthlyChart = null;
let severityChart = null;
let vendorChart = null;
let cweChart = null;

// Data caching
let yearDataCache = new Map();
let combinedAnalysisCache = new Map();
let isLoading = false;

// CVE_COLORS is already defined in base.html template

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupYearControls();
    loadGlobalStats();
    updateCharts();
});

function initializeCharts() {
    // Enhanced chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        animation: {
            duration: 750,
            easing: 'easeInOutQuart'
        }
    };

    // Year comparison chart with enhanced options
    const ctx1 = document.getElementById('yearComparisonChart').getContext('2d');
    yearComparisonChart = new Chart(ctx1, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            ...commonOptions,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'CVE Count'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // Monthly distribution chart
    const ctx2 = document.getElementById('monthlyChart').getContext('2d');
    monthlyChart = new Chart(ctx2, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            ...commonOptions,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'CVE Count'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                }
            }
        }
    });
    
    // Severity distribution chart
    const ctx3 = document.getElementById('severityChart').getContext('2d');
    severityChart = new Chart(ctx3, {
        type: 'doughnut',
        data: { labels: [], datasets: [] },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                            return `${context.label}: ${formatNumber(context.parsed)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Vendor chart (horizontal bar)
    const ctx4 = document.getElementById('vendorChart').getContext('2d');
    vendorChart = new Chart(ctx4, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            ...commonOptions,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'CVE Count'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'CNA Assigner'
                    }
                }
            },
            plugins: {
                ...commonOptions.plugins,
                legend: {
                    display: false
                }
            }
        }
    });

    // CWE chart (horizontal bar)
    const ctx5 = document.getElementById('cweChart').getContext('2d');
    cweChart = new Chart(ctx5, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            ...commonOptions,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'CVE Count'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'CWE ID'
                    }
                }
            },
            plugins: {
                ...commonOptions.plugins,
                legend: {
                    display: false
                }
            }
        }
    });
}

// Load global statistics from combined analysis
async function loadGlobalStats() {
    try {
        const response = await fetch('data/cve_all.json');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('totalCvesGlobal').textContent = formatNumber(data.total_cves);
            document.getElementById('avgPerYear').textContent = formatNumber(Math.round(data.total_cves / data.years_covered));
        }
    } catch (error) {
        console.warn('Could not load global stats:', error);
    }
}

// Enhanced data loading with caching
async function loadYearData(year) {
    if (yearDataCache.has(year)) {
        return yearDataCache.get(year);
    }
    
    try {
        const response = await fetch(`data/cve_${year}.json`);
        if (response.ok) {
            const data = await response.json();
            yearDataCache.set(year, data);
            return data;
        }
    } catch (error) {
        console.warn(`Could not load data for ${year}:`, error);
    }
    return null;
}

// Load combined analysis data
async function loadCombinedAnalysis(type) {
    if (combinedAnalysisCache.has(type)) {
        return combinedAnalysisCache.get(type);
    }
    
    try {
        const response = await fetch(`data/${type}_analysis.json`);
        if (response.ok) {
            const data = await response.json();
            combinedAnalysisCache.set(type, data);
            return data;
        }
    } catch (error) {
        console.warn(`Could not load ${type} analysis:`, error);
    }
    return null;
}

function setupYearControls() {
    const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                this.parentElement.classList.add('selected');
            } else {
                this.parentElement.classList.remove('selected');
            }
            updateSelectionInfo();
            updateCharts();
        });
    });
    
    updateSelectionInfo();
}

// Enhanced selection info with better formatting
async function updateSelectionInfo() {
    const selectedYears = Array.from(document.querySelectorAll('#yearSelector input:checked'))
        .map(cb => parseInt(cb.value))
        .sort((a, b) => a - b);
    
    const count = selectedYears.length;
    document.getElementById('selectionCount').textContent = `${count} year${count !== 1 ? 's' : ''} selected`;
    
    if (count === 0) {
        document.getElementById('totalCves').textContent = 'No years selected';
        document.getElementById('dateRange').textContent = '';
        return;
    }
    
    // Calculate total CVEs for selected years
    let totalCves = 0;
    for (const year of selectedYears) {
        const data = await loadYearData(year);
        if (data) {
            totalCves += data.total_cves || 0;
        }
    }
    
    document.getElementById('totalCves').textContent = `${formatNumber(totalCves)} CVEs`;
    
    // Show date range
    if (count === 1) {
        document.getElementById('dateRange').textContent = selectedYears[0].toString();
    } else {
        document.getElementById('dateRange').textContent = `${selectedYears[0]} - ${selectedYears[count - 1]}`;
    }
}

function selectRecentYears() {
    const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
    const currentYear = new Date().getFullYear();
    
    checkboxes.forEach(checkbox => {
        const year = parseInt(checkbox.value);
        if (year >= currentYear - 4) {
            checkbox.checked = true;
            checkbox.parentElement.classList.add('selected');
        } else {
            checkbox.checked = false;
            checkbox.parentElement.classList.remove('selected');
        }
    });
    
    updateSelectionInfo();
    updateCharts();
}

function selectDecade(startYear) {
    const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        const year = parseInt(checkbox.value);
        checkbox.checked = year >= startYear && year < startYear + 10;
    });
    
    updateSelectionInfo();
    updateCharts();
}

function selectAllYears() {
    const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectionInfo();
    updateCharts();
}

function clearAllYears() {
    const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.parentElement.classList.remove('selected');
    });
    updateSelectionInfo();
    updateCharts();
}

// Apply year range selection
function applyYearRange() {
    const startYear = parseInt(document.getElementById('startYear').value);
    const endYear = parseInt(document.getElementById('endYear').value);
    
    if (startYear > endYear) {
        alert('Start year must be less than or equal to end year');
        return;
    }
    
    const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        const year = parseInt(checkbox.value);
        if (year >= startYear && year <= endYear) {
            checkbox.checked = true;
            checkbox.parentElement.classList.add('selected');
        } else {
            checkbox.checked = false;
            checkbox.parentElement.classList.remove('selected');
        }
    });
    
    updateSelectionInfo();
    updateCharts();
}

// Update year range dropdowns
function updateYearRange() {
    // Auto-apply when both dropdowns are changed
    const startYear = parseInt(document.getElementById('startYear').value);
    const endYear = parseInt(document.getElementById('endYear').value);
    
    if (startYear <= endYear) {
        applyYearRange();
    }
}

async function updateCharts() {
    if (isLoading) return;
    isLoading = true;
    
    const selectedYears = Array.from(document.querySelectorAll('#yearSelector input:checked'))
        .map(cb => parseInt(cb.value))
        .sort((a, b) => a - b);
    
    if (selectedYears.length === 0) {
        // Clear all charts
        clearAllCharts();
        isLoading = false;
        return;
    }
    
    // Show loading indicators
    showLoadingState();
    
    // Load data for selected years
    const yearData = [];
    for (const year of selectedYears) {
        const data = await loadYearData(year);
        if (data) {
            yearData.push(data);
        }
    }
    
    // Hide loading indicators
    hideLoadingState();
    
    // Update all charts
    updateYearComparisonChart(yearData);
    updateMonthlyChart(yearData);
    updateSeverityChart(yearData);
    updateVendorChart(yearData);
    updateCweChart(yearData);
    
    isLoading = false;
}

function updateYearComparisonChart(yearData) {
    const labels = yearData.map(d => d.year);
    const data = yearData.map(d => d.total_cves);
    
    yearComparisonChart.data = {
        labels: labels,
        datasets: [{
            label: 'Total CVEs',
            data: data,
            borderColor: CVE_COLORS.primary,
            backgroundColor: CVE_COLORS.primary + '20',
            tension: 0.1,
            fill: true
        }]
    };
    
    yearComparisonChart.update();
}

function updateMonthlyChart(yearData) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    const datasets = yearData.map((data, index) => ({
        label: data.year.toString(),
        data: data.monthly_counts || new Array(12).fill(0),
        backgroundColor: getChartColors(yearData.length)[index] + '80',
        borderColor: getChartColors(yearData.length)[index],
        borderWidth: 1
    }));
    
    monthlyChart.data = {
        labels: months,
        datasets: datasets
    };
    
    monthlyChart.update();
}

function updateSeverityChart(yearData) {
    const viewType = document.getElementById('severityViewType')?.value || 'combined';
    
    if (viewType === 'combined') {
        // Aggregate severity data across all selected years
        const severityTotals = {};
        
        yearData.forEach(data => {
            const cvssData = data.cvss || {};
            Object.keys(cvssData).forEach(version => {
                const versionData = cvssData[version];
                if (versionData.severity_distribution) {
                    Object.keys(versionData.severity_distribution).forEach(severity => {
                        severityTotals[severity] = (severityTotals[severity] || 0) + versionData.severity_distribution[severity];
                    });
                }
            });
        });
        
        const labels = Object.keys(severityTotals).sort();
        const data = labels.map(label => severityTotals[label]);
        const colors = getSeverityColors(labels);
        
        severityChart.data = {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.map(color => color + '80'),
                borderColor: colors,
                borderWidth: 2
            }]
        };
    }
    
    severityChart.update();
}

// New chart update functions
function updateVendorChart(yearData) {
    // Aggregate vendor data across all selected years
    const vendorTotals = {};
    
    yearData.forEach(data => {
        const vendors = data.vendors?.cna_assigners || {};
        Object.keys(vendors).forEach(vendor => {
            vendorTotals[vendor] = (vendorTotals[vendor] || 0) + vendors[vendor];
        });
    });
    
    // Get top 10 vendors
    const sortedVendors = Object.entries(vendorTotals)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
    
    const labels = sortedVendors.map(([vendor]) => vendor.length > 20 ? vendor.substring(0, 20) + '...' : vendor);
    const data = sortedVendors.map(([,count]) => count);
    
    vendorChart.data = {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: CVE_COLORS.primary + '80',
            borderColor: CVE_COLORS.primary,
            borderWidth: 1
        }]
    };
    
    vendorChart.update();
}

function updateCweChart(yearData) {
    // Aggregate CWE data across all selected years
    const cweTotals = {};
    
    yearData.forEach(data => {
        const cwes = data.cwe?.top_cwes || {};
        Object.keys(cwes).forEach(cwe => {
            cweTotals[cwe] = (cweTotals[cwe] || 0) + cwes[cwe];
        });
    });
    
    // Get top 10 CWEs
    const sortedCwes = Object.entries(cweTotals)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
    
    const labels = sortedCwes.map(([cwe]) => cwe);
    const data = sortedCwes.map(([,count]) => count);
    
    cweChart.data = {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: CVE_COLORS.secondary + '80',
            borderColor: CVE_COLORS.secondary,
            borderWidth: 1
        }]
    };
    
    cweChart.update();
}

// Utility functions
function clearAllCharts() {
    const emptyData = { labels: [], datasets: [] };
    yearComparisonChart.data = emptyData;
    monthlyChart.data = emptyData;
    severityChart.data = emptyData;
    vendorChart.data = emptyData;
    cweChart.data = emptyData;
    
    yearComparisonChart.update();
    monthlyChart.update();
    severityChart.update();
    vendorChart.update();
    cweChart.update();
}

function showLoadingState() {
    // Add loading indicators to chart containers
    const containers = document.querySelectorAll('.chart-wrapper');
    containers.forEach(container => {
        container.style.opacity = '0.6';
        container.style.pointerEvents = 'none';
    });
}

function hideLoadingState() {
    const containers = document.querySelectorAll('.chart-wrapper');
    containers.forEach(container => {
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
    });
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toLocaleString();
}

function getChartColors(count) {
    const colors = [
        CVE_COLORS.primary,
        CVE_COLORS.secondary,
        CVE_COLORS.success,
        CVE_COLORS.warning,
        CVE_COLORS.danger,
        CVE_COLORS.info,
        '#e83e8c',
        '#6610f2',
        '#fd7e14',
        '#20c997'
    ];
    
    // Repeat colors if we need more
    const result = [];
    for (let i = 0; i < count; i++) {
        result.push(colors[i % colors.length]);
    }
    return result;
}

function getSeverityColors(severities) {
    const severityColorMap = {
        'CRITICAL': CVE_COLORS.danger,
        'HIGH': '#ff6b35',
        'MEDIUM': CVE_COLORS.warning,
        'LOW': CVE_COLORS.success,
        'UNKNOWN': CVE_COLORS.light
    };
    
    return severities.map(severity => severityColorMap[severity] || CVE_COLORS.primary);
}

// View type handlers
function updateTrendView() {
    updateCharts();
}

function updateMonthlyView() {
    updateCharts();
}

function updateSeverityView() {
    updateCharts();
}

// Export and share functionality
function exportSelection() {
    const selectedYears = Array.from(document.querySelectorAll('#yearSelector input:checked'))
        .map(cb => parseInt(cb.value))
        .sort((a, b) => a - b);
    
    if (selectedYears.length === 0) {
        alert('Please select at least one year to export');
        return;
    }
    
    // Create export data
    const exportData = {
        years: selectedYears,
        exported_at: new Date().toISOString(),
        source: 'CVE.ICU Year Analysis'
    };
    
    // Download as JSON
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cve-analysis-${selectedYears[0]}-${selectedYears[selectedYears.length - 1]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function shareSelection() {
    const selectedYears = Array.from(document.querySelectorAll('#yearSelector input:checked'))
        .map(cb => parseInt(cb.value))
        .sort((a, b) => a - b);
    
    if (selectedYears.length === 0) {
        alert('Please select at least one year to share');
        return;
    }
    
    // Create shareable URL with selected years
    const url = new URL(window.location);
    url.searchParams.set('years', selectedYears.join(','));
    
    // Copy to clipboard
    navigator.clipboard.writeText(url.toString()).then(() => {
        alert('Shareable URL copied to clipboard!');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = url.toString();
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Shareable URL copied to clipboard!');
    });
}

// Load URL parameters on page load
function loadUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const yearsParam = urlParams.get('years');
    
    if (yearsParam) {
        const years = yearsParam.split(',').map(y => parseInt(y));
        const checkboxes = document.querySelectorAll('#yearSelector input[type="checkbox"]');
        
        // Clear all first
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.parentElement.classList.remove('selected');
        });
        
        // Select specified years
        checkboxes.forEach(checkbox => {
            const year = parseInt(checkbox.value);
            if (years.includes(year)) {
                checkbox.checked = true;
                checkbox.parentElement.classList.add('selected');
            }
        });
        
        updateSelectionInfo();
        updateCharts();
    }
}

// Initialize URL parameters after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadUrlParameters, 100); // Small delay to ensure everything is initialized
});
</script>
{% endblock %}
