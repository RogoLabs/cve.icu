{% extends "base.html" %}

{% block title %}CWE Analysis - CVE.ICU{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="page-header mb-4 text-center">
    <h1 class="display-4 mb-2">CWE Intelligence Dashboard</h1>
    <small class="text-muted d-block mb-3" id="pageSubtitle">
        Showing comprehensive analysis across all years (1999-2025)
    </small>
    
    <!-- Data Mode Toggle -->
    <div class="d-flex justify-content-center mb-3">
        <button type="button" id="dataToggleBtn" onclick="toggleDataMode()" style="
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            transition: all 0.15s ease-in-out;
            background: none;
            border: 2px solid var(--color-border);
            cursor: pointer;
            font-size: inherit;
        " onmouseover="this.style.color='var(--color-accent)'; this.style.backgroundColor='rgba(13, 110, 253, 0.1)'; this.style.borderColor='var(--color-accent)'" onmouseout="this.style.color='var(--color-text-secondary)'; this.style.backgroundColor='transparent'; this.style.borderColor='var(--color-border)'">
            <span id="toggleText">Switch to 2025 Only</span>
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-number" id="totalCwes">Loading...</div>
        <div class="stat-label">Total CWEs</div>
        <small class="text-muted" style="font-size: 0.75rem;">üîç Unique weakness types</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="totalCvesWithCwe">Loading...</div>
        <div class="stat-label">CVEs with CWE</div>
        <small class="text-muted" style="font-size: 0.75rem;">üìä Classified vulnerabilities</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="topCwePercentage">Loading...</div>
        <div class="stat-label" id="topCweLabel">Loading...</div>
        <small class="text-muted" style="font-size: 0.75rem;">üéØ Most common weakness</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="top5CweShare">Loading...</div>
        <div class="stat-label">Top 5 CWE Share</div>
        <small class="text-muted" style="font-size: 0.75rem;">üìà Concentration ratio</small>
    </div>
</div>

<!-- Top CWEs Chart and CWE Categories -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">Top Common Weakness Enumerations</h3>
                <small class="text-muted">Most frequently occurring vulnerability types</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="topCwesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">CWE Categories</h3>
                <small class="text-muted">Distribution by weakness type</small>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="cweCategoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Smart Insights Panel -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üîç CWE Intelligence Insights</h3>
    </div>
    <div class="card-body py-3">
        <div class="row" id="cweInsights">
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üèÜ</div>
                    <div class="insight-content">
                        <div class="insight-title">Most Critical</div>
                        <div class="insight-text" id="criticalInsight">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-content">
                        <div class="insight-title">Trend Analysis</div>
                        <div class="insight-text" id="trendInsight">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üéØ</div>
                    <div class="insight-content">
                        <div class="insight-title">Focus Areas</div>
                        <div class="insight-text" id="focusInsight">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed CWE Table -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üìã Comprehensive CWE Directory</h3>
        <small class="text-muted">All Common Weakness Enumerations with vulnerability statistics - Click column headers to sort</small>
    </div>
    <div class="card-body py-3">
        <div class="table-responsive">
            <table class="table table-hover" id="cweTable">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="rank" style="cursor: pointer;">Rank <span class="sort-indicator">‚ñ≤</span></th>
                        <th class="sortable" data-sort="id" style="cursor: pointer;">CWE ID <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="name" style="cursor: pointer;">Description <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="count" style="cursor: pointer;">CVE Count <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="percentage" style="cursor: pointer;">Percentage <span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="cweTableBody">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Loading CWE data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="mt-3 text-center">
            <div class="text-muted mb-2" id="paginationInfo">
                Showing 1-25 of 0 CWEs
            </div>
            <nav aria-label="CWE table pagination" class="d-inline-block">
                <ul class="pagination pagination-sm mb-0" id="paginationControls">
                    <!-- Pagination will be dynamically generated -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Export and Share Panel -->
<div class="card mb-3">
    <div class="card-header py-2">
        <h2 class="card-title mb-0" style="font-size: 1.1rem;">üì§ Export & Share</h2>
    </div>
    <div class="card-body py-3">
        <div class="export-buttons">
            <button class="btn btn-primary btn-sm" onclick="exportCweCSV()">üìä Export CSV</button>
            <button class="btn btn-primary btn-sm" onclick="exportCweJSON()">üìã Export JSON</button>
            <button class="btn btn-secondary btn-sm" onclick="generatePermalink()">üîó Share Link</button>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è Print Report</button>
        </div>
        <div class="permalink-result mt-2" id="permalinkResult" style="display: none;">
            <input type="text" class="form-control" id="permalinkInput" readonly>
            <button class="btn btn-outline-primary btn-sm mt-1" onclick="copyPermalink()">Copy Link</button>
        </div>
    </div>
</div>

<!-- Data Source Note -->
<div class="text-center text-muted small mb-3">
    <p class="mb-1">
        <i class="fas fa-database me-1"></i>
        Data sourced from NVD (National Vulnerability Database) and processed through CVE.ICU analytics pipeline
    </p>
    <p class="mb-0">
        <i class="fas fa-clock me-1"></i>
        Last updated: <span id="lastUpdated">Loading...</span> | 
        <i class="fas fa-sync-alt me-1"></i>
        Updates every 6 hours
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables (CNA approach)
let cweData = null;
let currentYearCweData = null;
let isCurrentYearMode = false;
let topCwesChart = null;
let cweCategoryChart = null;

// Table pagination and sorting variables (from CNA)
let sortedData = [];
let currentPage = 1;
const itemsPerPage = 25;
let currentSort = {
    field: 'rank',
    direction: 'asc'
};

// Chart.js color palette - matching site's blue/grey design system
const colorPalette = [
    '#0d6efd', // Primary blue
    '#6c757d', // Secondary grey
    '#495057', // Dark grey
    '#adb5bd', // Medium grey
    '#343a40', // Darker grey
    '#1a73e8', // Lighter blue
    '#4285f4', // Google blue
    '#5f6368', // Medium dark grey
    '#80868b', // Light grey
    '#9aa0a6', // Lighter grey
    '#0052cc', // Dark blue
    '#1976d2', // Material blue
    '#37474f', // Blue grey
    '#546e7a', // Blue grey light
    '#78909c'  // Blue grey lighter
];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadCweData();
    updatePermalink();
});

// Load CWE data
async function loadCweData() {
    try {
        // Load both comprehensive and current year data
        const [comprehensiveResponse, currentYearResponse] = await Promise.all([
            fetch('/data/cwe_analysis.json'),
            fetch('/data/cwe_analysis_current_year.json')
        ]);
        
        if (!comprehensiveResponse.ok || !currentYearResponse.ok) {
            throw new Error('Failed to load CWE data');
        }
        
        cweData = await comprehensiveResponse.json();
        currentYearCweData = await currentYearResponse.json();
        
        // Initialize with comprehensive data
        displayCweData(cweData);
        
    } catch (error) {
        console.error('Error loading CWE data:', error);
        showErrorState();
    }
}

// Display CWE data
function displayCweData(data) {
    updateStatistics(data);
    updateCharts(data);
    populateTable();
    updateInsights(data);
    updateLastUpdated(data.generated_at);
}

// Update statistics cards
function updateStatistics(data) {
    const totalCwes = data.total_unique_cwes || 0;
    const totalCvesWithCwe = data.total_cves_with_cwe || 0;
    const topCwes = data.top_cwes || [];
    
    document.getElementById('totalCwes').textContent = totalCwes.toLocaleString();
    document.getElementById('totalCvesWithCwe').textContent = totalCvesWithCwe.toLocaleString();
    
    if (topCwes.length > 0) {
        const topCwe = topCwes[0];
        const topCwePercentage = ((topCwe.count / totalCvesWithCwe) * 100).toFixed(1);
        const topCweName = topCwe.name || `CWE-${topCwe.id}`;
        const topCweId = `CWE-${topCwe.id}`;
        
        // Update top CWE display to show percentage and CWE ID as label
        const topCweElement = document.getElementById('topCwePercentage');
        const topCweLabelElement = document.getElementById('topCweLabel');
        
        topCweElement.textContent = `${topCwePercentage}%`;
        topCweLabelElement.textContent = topCweId;
        topCweElement.title = `${topCweName}: ${topCwe.count.toLocaleString()} CVEs out of ${totalCvesWithCwe.toLocaleString()} total`;
        
        const top5Total = topCwes.slice(0, 5).reduce((sum, cwe) => sum + cwe.count, 0);
        const top5Percentage = ((top5Total / totalCvesWithCwe) * 100).toFixed(1);
        document.getElementById('top5CweShare').textContent = `${top5Percentage}%`;
    } else {
        document.getElementById('topCwePercentage').textContent = '0%';
        document.getElementById('topCweLabel').textContent = 'No CWE Data';
        document.getElementById('top5CweShare').textContent = '0%';
    }
}

// Update charts
function updateCharts(data) {
    updateTopCwesChart(data);
    updateCweCategoryChart(data);
}

// Update top CWEs horizontal bar chart
function updateTopCwesChart(data) {
    const ctx = document.getElementById('topCwesChart').getContext('2d');
    const topCwes = (data.top_cwes_limited || data.top_cwes || []).slice(0, 15);
    
    if (topCwesChart) {
        topCwesChart.destroy();
    }
    
    topCwesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topCwes.map(cwe => {
                const name = cwe.name || `CWE-${cwe.id}`;
                return name.length > 40 ? name.substring(0, 37) + '...' : name;
            }),
            datasets: [{
                label: 'CVE Count',
                data: topCwes.map(cwe => cwe.count),
                backgroundColor: colorPalette.slice(0, topCwes.length),
                borderColor: colorPalette.slice(0, topCwes.length),
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const cwe = topCwes[context[0].dataIndex];
                            return cwe.name || `CWE-${cwe.id}`;
                        },
                        label: function(context) {
                            return `CVEs: ${context.parsed.x.toLocaleString()}`;
                        },
                        afterLabel: function(context) {
                            return 'Click to view on MITRE CWE';
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const cwe = topCwes[index];
                    const mitreUrl = `https://cwe.mitre.org/data/definitions/${cwe.id}.html`;
                    window.open(mitreUrl, '_blank', 'noopener,noreferrer');
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// Update CWE category pie chart
function updateCweCategoryChart(data) {
    const ctx = document.getElementById('cweCategoryChart').getContext('2d');
    const topCwes = data.top_cwes || [];
    
    // Categorize CWEs by type
    const categories = {
        'Injection': ['79', '89', '78', '94', '77', '74'],
        'Memory Safety': ['119', '120', '125', '787', '416', '476'],
        'Access Control': ['862', '863', '269', '287', '284'],
        'Input Validation': ['20', '22', '190', '352'],
        'Information Disclosure': ['200', '209', '532'],
        'Other': []
    };
    
    const categoryData = {};
    Object.keys(categories).forEach(cat => categoryData[cat] = 0);
    
    topCwes.forEach(cwe => {
        const cweId = cwe.id;
        let categorized = false;
        
        for (const [category, ids] of Object.entries(categories)) {
            if (category !== 'Other' && ids.includes(cweId)) {
                categoryData[category] += cwe.count;
                categorized = true;
                break;
            }
        }
        
        if (!categorized) {
            categoryData['Other'] += cwe.count;
        }
    });
    
    const labels = Object.keys(categoryData).filter(cat => categoryData[cat] > 0);
    const values = labels.map(cat => categoryData[cat]);
    
    if (cweCategoryChart) {
        cweCategoryChart.destroy();
    }
    
    cweCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colorPalette.slice(0, labels.length),
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = values.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Update insights
function updateInsights(data) {
    const topCwes = data.top_cwes || [];
    const totalCvesWithCwe = data.total_cves_with_cwe || 0;
    
    if (topCwes.length > 0) {
        // Most Critical insight
        const topCwe = topCwes[0];
        const percentage = ((topCwe.count / totalCvesWithCwe) * 100).toFixed(1);
        document.getElementById('criticalInsight').innerHTML = 
            `<strong>${topCwe.name || `CWE-${topCwe.id}`}</strong> leads with ${topCwe.count.toLocaleString()} CVEs (${percentage}%)`;
        
        // Trend Analysis insight
        const injectionCwes = topCwes.filter(cwe => ['79', '89', '78', '94'].includes(cwe.id));
        const injectionTotal = injectionCwes.reduce((sum, cwe) => sum + cwe.count, 0);
        const injectionPercentage = ((injectionTotal / totalCvesWithCwe) * 100).toFixed(1);
        document.getElementById('trendInsight').innerHTML = 
            `Injection vulnerabilities account for <strong>${injectionPercentage}%</strong> of classified CVEs`;
        
        // Focus Areas insight
        const top3Total = topCwes.slice(0, 3).reduce((sum, cwe) => sum + cwe.count, 0);
        const top3Percentage = ((top3Total / totalCvesWithCwe) * 100).toFixed(1);
        document.getElementById('focusInsight').innerHTML = 
            `Top 3 CWEs represent <strong>${top3Percentage}%</strong> of all classified vulnerabilities`;
    } else {
        document.getElementById('criticalInsight').textContent = 'No data available';
        document.getElementById('trendInsight').textContent = 'No data available';
        document.getElementById('focusInsight').textContent = 'No data available';
    }
}

// Simple working table update (minimal approach)
function populateTable() {
    console.log('populateTable() called - using simple approach');
    const currentData = isCurrentYearMode ? currentYearCweData : cweData;
    
    if (!currentData || !currentData.top_cwes) {
        console.error('No data available');
        return;
    }
    
    const cwes = currentData.top_cwes;
    const totalCvesWithCwe = currentData.total_cves_with_cwe || 0;
    
    // Simple pagination calculation
    const totalPages = Math.ceil(cwes.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = cwes.slice(startIndex, endIndex);
    
    // Update table body
    const tbody = document.getElementById('cweTableBody');
    tbody.innerHTML = '';
    
    pageData.forEach((cwe, index) => {
        const rank = startIndex + index + 1;
        const percentage = ((cwe.count / totalCvesWithCwe) * 100).toFixed(2);
        const name = cwe.name || `CWE-${cwe.id}`;
        const mitreUrl = `https://cwe.mitre.org/data/definitions/${cwe.id}.html`;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="badge bg-secondary">#${rank}</span></td>
            <td><a href="${mitreUrl}" target="_blank" rel="noopener noreferrer" class="text-decoration-none"><strong>CWE-${cwe.id}</strong></a></td>
            <td><a href="${mitreUrl}" target="_blank" rel="noopener noreferrer" class="text-decoration-none text-dark">${name}</a></td>
            <td>${cwe.count.toLocaleString()}</td>
            <td>${percentage}%</td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, cwes.length);
    document.getElementById('paginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${cwes.length} CWEs`;
    
    // Simple pagination controls
    updateSimplePagination(totalPages);
}

// Simple pagination controls that actually work
function updateSimplePagination(totalPages) {
    const paginationControls = document.getElementById('paginationControls');
    let html = '';
    
    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">&laquo;</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">&laquo;</span></li>`;
    }
    
    // Page numbers (show max 5 pages)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a></li>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">&raquo;</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">&raquo;</span></li>`;
    }
    
    paginationControls.innerHTML = html;
}

// Simple page change function
function changePage(page) {
    currentPage = page;
    populateTable();
}

// Change page (legacy function - now handled by setupPaginationHandlers)
function changePage(page) {
    const totalPages = Math.ceil(sortedData.length / itemsPerPage);
    
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTable();
    }
}

// Sort table
function sortTable(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'desc'; // Default to descending for most columns
        if (column === 1 || column === 2) sortDirection = 'asc'; // ID and Description default to ascending
    }
    
    currentPage = 1; // Reset to first page when sorting
    const data = isCurrentYearMode ? currentYearCweData : cweData;
    updateTable(data);
}

// Toggle between all data and current year (CNA approach)
function toggleDataMode() {
    isCurrentYearMode = !isCurrentYearMode;
    const data = isCurrentYearMode ? currentYearCweData : cweData;
    
    if (data) {
        displayCweData(data);
    }
    
    // Update button text
    const button = document.getElementById('dataToggleBtn');
    button.textContent = isCurrentYearMode ? 'Switch to All Data' : 'Switch to 2025 Only';
    
    // Reset pagination and sorting
    currentPage = 1;
    currentSort = {
        field: 'rank',
        direction: 'asc'
    };
}

// Toggle data mode
function toggleDataMode() {
    isCurrentYearMode = !isCurrentYearMode;
    
    // Update button text
    const button = document.getElementById('dataToggleBtn');
    button.textContent = isCurrentYearMode ? 'Switch to All Data' : 'Switch to 2025 Only';
    
    if (isCurrentYearMode) {
        toggleText.textContent = 'Switch to All Data';
        pageSubtitle.textContent = `Showing 2025 data only (${data.year || 'current year'})`;
    } else {
        toggleText.textContent = 'Switch to 2025 Only';
        pageSubtitle.textContent = 'Showing comprehensive analysis across all years (1999-2025)';
    }
    
    displayCweData(data);
}

// Update last updated timestamp
function updateLastUpdated(timestamp) {
    if (timestamp) {
        const date = new Date(timestamp);
        document.getElementById('lastUpdated').textContent = date.toLocaleString();
    }
}

// Update permalink
function updatePermalink() {
    const url = window.location.href;
    document.getElementById('permalinkInput').value = url;
}

// Copy permalink
function copyPermalink() {
    const input = document.getElementById('permalinkInput');
    input.select();
    document.execCommand('copy');
    
    const button = input.nextElementSibling;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.style.backgroundColor = '#198754';
    
    setTimeout(() => {
        button.textContent = originalText;
        button.style.backgroundColor = '';
    }, 2000);
}

// Export functions
function exportCweCSV() {
    const data = isCurrentYearMode ? currentYearCweData : cweData;
    if (!data || !data.top_cwes) {
        alert('No data available for export');
        return;
    }
    
    const totalCvesWithCwe = data.total_cves_with_cwe || 0;
    
    let csv = 'CWE Intelligence Dashboard Export\n\n';
    csv += 'Rank,CWE ID,Description,CVE Count,Percentage\n';
    
    data.top_cwes.forEach((cwe, index) => {
        const percentage = ((cwe.count / totalCvesWithCwe) * 100).toFixed(2);
        const name = (cwe.name || `CWE-${cwe.id}`).replace(/"/g, '""');
        csv += `${index + 1},CWE-${cwe.id},"${name}",${cwe.count},${percentage}%\n`;
    });
    
    csv += '\n\nSummary Statistics\n';
    csv += `Total CWEs,${data.total_unique_cwes}\n`;
    csv += `Total CVEs with CWE,${totalCvesWithCwe.toLocaleString()}\n`;
    csv += `Data Period,${isCurrentYearMode ? data.year || 'Current Year' : 'All Years (1999-2025)'}\n`;
    
    downloadFile(csv, `cwe-analysis-${isCurrentYearMode ? 'current-year' : 'comprehensive'}.csv`, 'text/csv');
}

function exportCweJSON() {
    const data = isCurrentYearMode ? currentYearCweData : cweData;
    if (!data) {
        alert('No data available for export');
        return;
    }
    
    const exportData = {
        metadata: {
            exportDate: new Date().toISOString(),
            dataSource: 'CVE.ICU CWE Intelligence Dashboard',
            dataPeriod: isCurrentYearMode ? (data.year || 'Current Year') : 'All Years (1999-2025)',
            totalCwes: data.total_unique_cwes,
            totalCvesWithCwe: data.total_cves_with_cwe
        },
        cweData: (data.top_cwes || []).map((cwe, index) => ({
            rank: index + 1,
            cweId: `CWE-${cwe.id}`,
            description: cwe.name || `CWE-${cwe.id}`,
            cveCount: cwe.count,
            percentage: ((cwe.count / (data.total_cves_with_cwe || 1)) * 100).toFixed(2)
        }))
    };
    
    const jsonStr = JSON.stringify(exportData, null, 2);
    downloadFile(jsonStr, `cwe-analysis-${isCurrentYearMode ? 'current-year' : 'comprehensive'}.json`, 'application/json');
}

// Permalink functionality
function generatePermalink() {
    const permalink = `${window.location.origin}${window.location.pathname}`;
    
    const resultDiv = document.getElementById('permalinkResult');
    const input = document.getElementById('permalinkInput');
    
    input.value = permalink;
    resultDiv.style.display = 'block';
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Error state
function showErrorState() {
    document.getElementById('totalCwes').textContent = 'Error';
    document.getElementById('totalCvesWithCwe').textContent = 'Error';
    document.getElementById('topCwePercentage').textContent = 'Error';
    document.getElementById('topCweLabel').textContent = 'Error';
    document.getElementById('top5CweShare').textContent = 'Error';
    
    document.getElementById('cweTableBody').innerHTML = 
        '<tr><td colspan="5" class="text-center text-danger">Error loading CWE data. Please refresh the page.</td></tr>';
}
</script>
{% endblock %}