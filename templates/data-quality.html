{% extends "base.html" %}

{% block title %}Data Quality - CVE.ICU{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="page-header mb-4 text-center">
    <h1 class="display-4 mb-2">Data Quality Dashboard</h1>
    <small class="text-muted d-block mb-3">
        Transparency into CVE data attribution gaps and anomalies
    </small>
</div>

<!-- Summary Stats -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-number" id="officialCnas">Loading...</div>
        <div class="stat-label">Official CNAs</div>
        <small class="text-muted" style="font-size: 0.75rem;">‚úÖ Verified in CNA registry</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="unmatchedCnas">Loading...</div>
        <div class="stat-label">Unmatched CNAs</div>
        <small class="text-muted" style="font-size: 0.75rem;">‚ö†Ô∏è Not in official registry</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="unmatchedCves">Loading...</div>
        <div class="stat-label">Unmatched CVEs</div>
        <small class="text-muted" style="font-size: 0.75rem;">üìä CVEs from unmatched sources</small>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="anomalyCount">Loading...</div>
        <div class="stat-label">Anomalies</div>
        <small class="text-muted" style="font-size: 0.75rem;">üîç Unusual patterns detected</small>
    </div>
</div>

<!-- Explanation Card -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">‚ÑπÔ∏è About This Dashboard</h3>
    </div>
    <div class="card-body py-3">
        <p class="mb-2">
            This dashboard provides transparency into data quality issues within the CVE ecosystem. 
            It highlights cases where CVE assigner names don't match the official CNA registry, 
            helping identify:
        </p>
        <ul class="mb-2" style="font-size: 0.9rem;">
            <li><strong>Name variations:</strong> Official CNAs using different name formats (e.g., "Samsung Electronics Co., Ltd." vs official registry entry)</li>
            <li><strong>Unofficial assigners:</strong> Organizations publishing CVEs outside the CNA program</li>
            <li><strong>Individual researchers:</strong> Security researchers assigned CVEs directly</li>
            <li><strong>Anomalies:</strong> Unusual patterns like high-volume inactive CNAs</li>
        </ul>
        <p class="mb-0 text-muted" style="font-size: 0.85rem;">
            <em>Note: These are data quality observations, not security concerns. Many "unmatched" CNAs are legitimate organizations with name format differences.</em>
        </p>
    </div>
</div>

<!-- Unmatched CNAs Table -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">‚ö†Ô∏è Top Unmatched CNAs</h3>
        <small class="text-muted">CVE assigners not found in official CNA registry (by CVE count)</small>
    </div>
    <div class="card-body py-3">
        <div class="table-responsive">
            <table class="table table-hover" id="unmatchedTable">
                <thead>
                    <tr>
                        <th style="width: 300px;">Assigner Name</th>
                        <th style="width: 120px;">CVE Count</th>
                        <th style="width: 150px;">Category</th>
                        <th>Possible Matches</th>
                    </tr>
                </thead>
                <tbody id="unmatchedTableBody">
                    <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Unofficial CNAs -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üîç Unofficial CVE Sources</h3>
        <small class="text-muted">Organizations publishing CVEs outside the official CNA program</small>
    </div>
    <div class="card-body py-3">
        <div class="table-responsive">
            <table class="table table-hover" id="unofficialTable">
                <thead>
                    <tr>
                        <th style="width: 300px;">Organization</th>
                        <th style="width: 120px;">CVE Count</th>
                        <th style="width: 120px;">Years Active</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="unofficialTableBody">
                    <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Likely Official (Mismatched Names) -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">‚úÖ Likely Official CNAs (Name Variations)</h3>
        <small class="text-muted">CNAs that appear official but use different name formats</small>
    </div>
    <div class="card-body py-3">
        <div class="table-responsive">
            <table class="table table-hover" id="likelyOfficialTable">
                <thead>
                    <tr>
                        <th style="width: 300px;">Name Used</th>
                        <th style="width: 120px;">CVE Count</th>
                        <th style="width: 120px;">Confidence</th>
                        <th>Reasoning</th>
                    </tr>
                </thead>
                <tbody id="likelyOfficialTableBody">
                    <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Anomalies -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üö® Detected Anomalies</h3>
        <small class="text-muted">Unusual patterns in CVE data</small>
    </div>
    <div class="card-body py-3">
        <div id="anomaliesList">
            <p class="text-center text-muted">Loading...</p>
        </div>
    </div>
</div>

<!-- Category Breakdown -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">üìä Unmatched by Category</h3>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header py-2">
                <h3 class="card-title" style="font-size: 1.1rem;">üìà Official vs Unofficial</h3>
            </div>
            <div class="card-body py-3">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="officialChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<style>
.anomaly-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--color-surface);
    border-radius: var(--border-radius);
    border-left: 3px solid #f59e0b;
}
.anomaly-type {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 0.9rem;
}
.anomaly-desc {
    color: var(--color-text-secondary);
    font-size: 0.85rem;
    margin-top: 0.25rem;
}
.category-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}
.category-name_variation { background: #dbeafe; color: #1e40af; }
.category-individual_researcher { background: #d1fae5; color: #065f46; }
.category-unknown { background: #f3f4f6; color: #374151; }
</style>

<script>
let dataQuality = null;
let charts = {};

// Load data and initialize page
async function loadDataQuality() {
    try {
        const response = await fetch('data/data_quality.json');
        dataQuality = await response.json();
        
        updateSummaryStats();
        populateUnmatchedTable();
        populateUnofficialTable();
        populateLikelyOfficialTable();
        populateAnomalies();
        createCharts();
        
    } catch (error) {
        console.error('Error loading data quality:', error);
        document.getElementById('unmatchedTableBody').innerHTML = 
            '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
    }
}

function updateSummaryStats() {
    const summary = dataQuality.summary;
    document.getElementById('officialCnas').textContent = summary.total_official_cnas.toLocaleString();
    document.getElementById('unmatchedCnas').textContent = summary.unmatched_cna_count.toLocaleString();
    document.getElementById('unmatchedCves').textContent = summary.unmatched_cve_total.toLocaleString();
    document.getElementById('anomalyCount').textContent = dataQuality.anomalies.length.toLocaleString();
}

function populateUnmatchedTable() {
    const tbody = document.getElementById('unmatchedTableBody');
    const cnas = dataQuality.unmatched_cnas.slice(0, 20);
    
    if (cnas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No unmatched CNAs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = cnas.map(cna => `
        <tr>
            <td><strong>${escapeHtml(cna.name)}</strong></td>
            <td>${cna.cve_count.toLocaleString()}</td>
            <td><span class="category-badge category-${cna.category}">${formatCategory(cna.category)}</span></td>
            <td>${cna.closest_matches.length > 0 ? cna.closest_matches.map(m => escapeHtml(m)).join(', ') : '<span class="text-muted">None found</span>'}</td>
        </tr>
    `).join('');
}

function populateUnofficialTable() {
    const tbody = document.getElementById('unofficialTableBody');
    const cnas = dataQuality.unofficial_cnas.slice(0, 15);
    
    if (cnas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No unofficial CNAs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = cnas.map(cna => `
        <tr>
            <td><strong>${escapeHtml(cna.name)}</strong></td>
            <td>${cna.cve_count.toLocaleString()}</td>
            <td>${cna.years_active} years</td>
            <td class="text-muted" style="font-size: 0.85rem;">${cna.reasoning.length > 0 ? escapeHtml(cna.reasoning[0].substring(0, 80)) + '...' : '-'}</td>
        </tr>
    `).join('');
}

function populateLikelyOfficialTable() {
    const tbody = document.getElementById('likelyOfficialTableBody');
    const cnas = dataQuality.likely_official_cnas || [];
    
    if (cnas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No likely official CNAs identified</td></tr>';
        return;
    }
    
    tbody.innerHTML = cnas.map(cna => `
        <tr>
            <td><strong>${escapeHtml(cna.name)}</strong></td>
            <td>${cna.cve_count.toLocaleString()}</td>
            <td><span class="badge bg-success">${cna.confidence}</span></td>
            <td class="text-muted" style="font-size: 0.85rem;">${cna.reasoning.length > 0 ? escapeHtml(cna.reasoning[0].substring(0, 100)) : '-'}</td>
        </tr>
    `).join('');
}

function populateAnomalies() {
    const container = document.getElementById('anomaliesList');
    const anomalies = dataQuality.anomalies;
    
    if (anomalies.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No anomalies detected</p>';
        return;
    }
    
    container.innerHTML = anomalies.map(anomaly => `
        <div class="anomaly-item">
            <div class="anomaly-type">${formatAnomalyType(anomaly.type)}: ${escapeHtml(anomaly.cna_name || 'Unknown')}</div>
            <div class="anomaly-desc">${escapeHtml(anomaly.description)}</div>
        </div>
    `).join('');
}

function createCharts() {
    // Category breakdown chart
    const categoryData = dataQuality.summary.unmatched_by_category || {};
    const categoryLabels = Object.keys(categoryData).map(formatCategory);
    const categoryValues = Object.values(categoryData);
    
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    charts.category = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#64748b', font: { size: 11 } }
                }
            }
        }
    });
    
    // Official vs unofficial chart
    const summary = dataQuality.summary;
    const officialCtx = document.getElementById('officialChart').getContext('2d');
    charts.official = new Chart(officialCtx, {
        type: 'bar',
        data: {
            labels: ['Official CNAs', 'Likely Official', 'Truly Unofficial'],
            datasets: [{
                data: [summary.total_official_cnas, summary.likely_official, summary.truly_unofficial],
                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                borderWidth: 0,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { color: '#64748b' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#64748b', font: { size: 10 } }
                }
            }
        }
    });
}

// Utility functions
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatCategory(category) {
    const formats = {
        'name_variation': 'Name Variation',
        'individual_researcher': 'Individual Researcher',
        'unknown': 'Unknown'
    };
    return formats[category] || category;
}

function formatAnomalyType(type) {
    const formats = {
        'high_volume_inactive': 'üìä High-Volume Inactive CNA',
        'major_vendor_unmatched': '‚ö†Ô∏è Major Vendor Unmatched'
    };
    return formats[type] || type;
}

// Initialize on load
document.addEventListener('DOMContentLoaded', loadDataQuality);
</script>
{% endblock %}
